<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>A Grand Tour - Route Map</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #legend {
            position: absolute;
            bottom: 30px;
            left: 10px;
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 13px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-width: 280px;
        }
        #legend h3 { margin: 0 0 10px 0; font-size: 14px; }
        .legend-item { display: flex; align-items: center; margin: 5px 0; }
        .legend-color { width: 20px; height: 4px; margin-right: 8px; border-radius: 2px; }
        .legend-dashed { border-top: 2px dashed; height: 0; }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 13px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-width: 300px;
        }
        #info h2 { margin: 0 0 5px 0; font-size: 16px; }
        #info p { margin: 5px 0; color: #666; }
        #controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        #controls label { display: block; margin: 5px 0; cursor: pointer; }
        .mapboxgl-popup-content {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 10px 15px;
        }
        .popup-title { font-weight: 600; font-size: 14px; }
        .popup-info { color: #666; font-size: 12px; margin-top: 4px; }
    </style>
</head>
<body>
<div id="map"></div>
<div id="info">
    <h2>A Grand Tour</h2>
    <p>15 years | 200,000 km | 100+ countries</p>
    <p>Feb 2027 – Aug 2042</p>
</div>
<div id="legend">
    <h3>Route Types</h3>
    <div class="legend-item"><div class="legend-color" style="background: #27ae60;"></div>Driving</div>
    <div class="legend-item"><div class="legend-color legend-dashed" style="border-color: #3498db;"></div>Ferry</div>
    <h3 style="margin-top: 10px; margin-bottom: 5px;">Shipping Routes</h3>
    <div class="legend-item"><div class="legend-color legend-dashed" style="border-color: #9b59b6;"></div>JB - Jakarta</div>
    <div class="legend-item"><div class="legend-color legend-dashed" style="border-color: #e67e22;"></div>Chittagong - Laem Chabang</div>
    <div class="legend-item"><div class="legend-color legend-dashed" style="border-color: #16a085;"></div>Brisbane - Auckland</div>
    <div class="legend-item"><div class="legend-color legend-dashed" style="border-color: #e91e63;"></div>Auckland - Valparaiso</div>
    <div class="legend-item"><div class="legend-color legend-dashed" style="border-color: #f39c12;"></div>Darien Gap (Cartagena - Panama)</div>
    <div class="legend-item"><div class="legend-color legend-dashed" style="border-color: #2c3e50;"></div>Seattle - Southampton</div>
</div>
<div id="controls">
    <strong>Show/Hide</strong>
    <label><input type="checkbox" id="toggle-driving" checked> Driving</label>
    <label><input type="checkbox" id="toggle-ferry" checked> Ferries</label>
    <label><input type="checkbox" id="toggle-shipping" checked> Shipping</label>
</div>

<script>
mapboxgl.accessToken = 'pk.eyJ1Ijoiamx4cTAiLCJhIjoiY21qd2QwOGRpNXVuNzNnb2txNmdkemd2ZyJ9.JpfheNv0aknnk-pbhNOGQg';

const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v11',
    center: [40, 20],
    zoom: 1.5
});

const colors = {
    driving: '#27ae60',
    ferry: '#3498db'
};

const shippingColors = {
    'jb-jakarta': '#9b59b6',
    'darien-gap': '#f39c12',
    'chittagong-laem-chabang': '#e67e22',
    'brisbane-auckland': '#16a085',
    'auckland-valparaiso': '#e91e63',
    'seattle-southampton': '#2c3e50'
};

// Load all GeoJSON data
async function loadData() {
    const [stops, roads, ferries, ...shipping] = await Promise.all([
        fetch('data/stops.geojson').then(r => r.json()),
        fetch('data/roads.geojson').then(r => r.json()),
        fetch('data/ferries.geojson').then(r => r.json()),
        fetch('data/shipping/jb-jakarta.geojson').then(r => r.json()),
        fetch('data/shipping/darien-gap.geojson').then(r => r.json()),
        fetch('data/shipping/chittagong-laem-chabang.geojson').then(r => r.json()),
        fetch('data/shipping/brisbane-auckland.geojson').then(r => r.json()),
        fetch('data/shipping/auckland-valparaiso.geojson').then(r => r.json()),
        fetch('data/shipping/seattle-southampton.geojson').then(r => r.json())
    ]);

    return {
        stops,
        roads,
        ferries,
        shipping: {
            'jb-jakarta': shipping[0],
            'darien-gap': shipping[1],
            'chittagong-laem-chabang': shipping[2],
            'brisbane-auckland': shipping[3],
            'auckland-valparaiso': shipping[4],
            'seattle-southampton': shipping[5]
        }
    };
}

map.on('load', async () => {
    const data = await loadData();

    // Add road segments
    map.addSource('roads', { type: 'geojson', data: data.roads });
    map.addLayer({
        id: 'roads',
        type: 'line',
        source: 'roads',
        paint: {
            'line-color': colors.driving,
            'line-width': 3,
            'line-opacity': 0.8
        }
    });

    // Add ferry routes
    map.addSource('ferries', { type: 'geojson', data: data.ferries });
    map.addLayer({
        id: 'ferries',
        type: 'line',
        source: 'ferries',
        paint: {
            'line-color': colors.ferry,
            'line-width': 2.5,
            'line-dasharray': [4, 3],
            'line-opacity': 0.9
        }
    });

    // Add shipping routes
    Object.keys(data.shipping).forEach(key => {
        map.addSource(`shipping-${key}`, { type: 'geojson', data: data.shipping[key] });
        map.addLayer({
            id: `shipping-${key}`,
            type: 'line',
            source: `shipping-${key}`,
            paint: {
                'line-color': shippingColors[key],
                'line-width': 2.5,
                'line-dasharray': [6, 4],
                'line-opacity': 0.9
            }
        });
    });

    // Add markers for all stops
    data.stops.features.forEach(stop => {
        const el = document.createElement('div');
        el.className = 'marker';
        el.style.width = '8px';
        el.style.height = '8px';
        el.style.backgroundColor = colors.driving;
        el.style.borderRadius = '50%';
        el.style.border = '2px solid white';
        el.style.boxShadow = '0 1px 3px rgba(0,0,0,0.3)';
        el.style.cursor = 'pointer';

        const props = stop.properties;
        const phase = props.trip <= 13 ? 'A' : 'B';
        const popup = new mapboxgl.Popup({ offset: 10 })
            .setHTML(`
                <div class="popup-title">${props.name}</div>
                <div class="popup-info">${props.country} · Trip ${props.trip} · Phase ${phase}</div>
            `);

        new mapboxgl.Marker(el)
            .setLngLat(stop.geometry.coordinates)
            .setPopup(popup)
            .addTo(map);
    });

    // Toggle controls
    document.getElementById('toggle-driving').addEventListener('change', (e) => {
        map.setLayoutProperty('roads', 'visibility', e.target.checked ? 'visible' : 'none');
        document.querySelectorAll('.marker').forEach(m => m.style.display = e.target.checked ? 'block' : 'none');
    });

    document.getElementById('toggle-ferry').addEventListener('change', (e) => {
        map.setLayoutProperty('ferries', 'visibility', e.target.checked ? 'visible' : 'none');
    });

    document.getElementById('toggle-shipping').addEventListener('change', (e) => {
        const visibility = e.target.checked ? 'visible' : 'none';
        Object.keys(data.shipping).forEach(key => {
            map.setLayoutProperty(`shipping-${key}`, 'visibility', visibility);
        });
    });
});

map.addControl(new mapboxgl.NavigationControl());
</script>
</body>
</html>
