<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>A Grand Tour - Scenic Routes & Points of Interest</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 13px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-width: 280px;
        }
        #info h2 { margin: 0 0 5px 0; font-size: 16px; }
        #info p { margin: 5px 0; color: #666; }
        #route-info {
            position: absolute;
            background: #fff;
            border-radius: 12px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
            display: none;
            width: 320px;
            overflow: hidden;
            z-index: 10;
            pointer-events: auto;
        }
        #route-photo-container {
            position: relative;
            width: 100%;
            height: 180px;
            background: #222;
        }
        #route-photo {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }
        .carousel-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .carousel-btn:hover { background: rgba(0,0,0,0.7); }
        #carousel-prev { left: 8px; }
        #carousel-next { right: 8px; }
        #carousel-dots {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 6px;
        }
        .carousel-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            cursor: pointer;
        }
        .carousel-dot.active { background: white; }
        #route-content {
            padding: 14px 16px;
        }
        #route-info h3 { margin: 0 0 4px 0; font-size: 17px; font-weight: 600; }
        #route-info .country { color: #666; margin: 0 0 8px 0; font-size: 13px; }
        #route-info .rating { color: #f39c12; margin: 0 0 10px 0; font-size: 15px; letter-spacing: 1px; }
        #route-info .description { color: #333; margin: 0; line-height: 1.5; font-size: 13px; }
        #route-close {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 18px;
            line-height: 26px;
            text-align: center;
        }
        #route-close:hover { background: rgba(0,0,0,0.7); }
        .legend {
            position: absolute;
            bottom: 30px;
            left: 10px;
            background: rgba(255,255,255,0.95);
            padding: 12px 16px;
            border-radius: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1;
        }
        .legend h4 { margin: 0 0 8px 0; font-size: 13px; }
        .legend-item { display: flex; align-items: center; margin: 4px 0; }
        .legend-line { width: 24px; height: 3px; margin-right: 8px; border-radius: 2px; }
    </style>
</head>
<body>
<div id="map"></div>
<div id="info">
    <h2>A Grand Tour</h2>
    <p style="margin-bottom: 10px; color: #333; font-style: italic;">One Family. One Land Cruiser. 100 Countries.</p>
    <p style="font-size: 11px; color: #888;">Click routes, POIs, ferries, or shipping for details</p>
</div>
<div id="route-info">
    <button id="route-close">Ã—</button>
    <div id="route-photo-container">
        <img id="route-photo" src="" alt="Route photo">
        <button class="carousel-btn" id="carousel-prev">â€¹</button>
        <button class="carousel-btn" id="carousel-next">â€º</button>
        <div id="carousel-dots"></div>
    </div>
    <div id="route-content">
        <h3 id="route-name"></h3>
        <p class="country" id="route-country"></p>
        <p class="rating" id="route-rating"></p>
        <p class="description" id="route-description"></p>
    </div>
</div>
<div class="legend">
    <h4>Rating</h4>
    <div class="legend-item"><div class="legend-line" style="background: #e74c3c;"></div> 5 stars</div>
    <div class="legend-item"><div class="legend-line" style="background: #e67e22;"></div> 4 stars</div>
    <div class="legend-item"><div class="legend-line" style="background: #f39c12;"></div> 3 stars</div>
    <div class="legend-item"><div class="legend-line" style="background: #f1c40f;"></div> 1-2 stars</div>
    <h4 style="margin-top: 10px;">Type</h4>
    <div class="legend-item"><div class="legend-line" style="background: #3498db;"></div> Planned route</div>
    <div class="legend-item"><div class="legend-line" style="background: #888; height: 3px;"></div> Scenic route</div>
    <div class="legend-item"><div style="width: 10px; height: 10px; border-radius: 50%; background: #888; margin-right: 8px;"></div> POI</div>
</div>

<script>
mapboxgl.accessToken = 'pk.eyJ1Ijoiamx4cTAiLCJhIjoiY21qd2QwOGRpNXVuNzNnb2txNmdkemd2ZyJ9.JpfheNv0aknnk-pbhNOGQg';

const routeFiles = [
    'ae-jebel-hafeet.geojson','ae-khor-fakkan.geojson','al-llogara-pass.geojson','ar-calchaqui.geojson',
    'ar-el-chalten.geojson','ar-paso-caracoles.geojson','ar-ruta-40.geojson','ar-seven-lakes.geojson',
    'at-grossglockner.geojson','au-gibb-river-road.geojson','au-great-alpine-road.geojson',
    'au-great-ocean-road.geojson','au-nullarbor.geojson','au-outback-way.geojson','bo-death-road.geojson',
    'bo-salar-uyuni.geojson','br-serra-rio-rastro.geojson','bz-hummingbird-highway.geojson',
    'ca-cabot-trail.geojson','ca-icefields-parkway.geojson','ca-sea-to-sky.geojson','ch-furka-pass.geojson',
    'ch-grimsel-pass.geojson','ch-susten-pass.geojson','cl-carretera-austral.geojson',
    'cl-general-carrera.geojson','cn-tianmen-mountain.geojson','cr-braulio-carrillo.geojson',
    'cr-cerro-muerte.geojson','de-alpine-road.geojson','de-black-forest.geojson','de-romantic-road.geojson',
    'de-wine-route.geojson','ec-avenue-volcanoes.geojson','es-sa-calobra.geojson','et-simien-mountains.geojson',
    'fi-archipelago-trail.geojson','fr-col-de-turini.geojson','fr-combe-laval.geojson','fr-grandes-alpes.geojson',
    'fr-lacets-montvernier.geojson','fr-route-napoleon.geojson','fr-verdon-gorge.geojson',
    'gb-bealach-na-ba.geojson','gb-causeway-coastal.geojson','gb-nc500.geojson','gr-vikos-gorge.geojson',
    'gt-lake-atitlan.geojson','hr-adriatic-highway.geojson','hr-gorski-kotar.geojson','id-mount-bromo.geojson',
    'in-kochi-munnar.geojson','in-manali-leh.geojson','in-spiti-valley.geojson','in-srinagar-leh.geojson',
    'is-ring-road.geojson','it-amalfi-coast.geojson','it-dolomites.geojson','it-stelvio-pass.geojson',
    'it-strada-della-forra.geojson','jo-kings-highway.geojson','jo-wadi-rum.geojson','ma-dades-gorge.geojson',
    'ma-tizi-ntichka.geojson','ma-todra-gorge.geojson','mx-baja-highway-1.geojson','mx-chiapas.geojson',
    'mx-copper-canyon.geojson','mx-devils-backbone.geojson','mx-oaxaca-coast.geojson',
    'mx-pacific-coast-200.geojson','mx-valle-guadalupe.geojson','my-cameron-highlands.geojson',
    'na-fish-river-canyon.geojson','na-sossusvlei-skeleton.geojson','no-atlantic-road.geojson',
    'no-geirangerfjord.geojson','no-lofoten.geojson','no-trollstigen.geojson','np-kathmandu-pokhara.geojson',
    'nz-arthurs-pass.geojson','nz-crown-range.geojson','nz-forgotten-world.geojson','nz-milford-road.geojson',
    'nz-queen-charlotte.geojson','nz-queenstown-glenorchy.geojson','om-jebel-akhdar.geojson',
    'om-jebel-shams.geojson','om-muscat-salalah.geojson','om-wadi-bani-awf.geojson','pa-darien.geojson',
    'pe-sacred-valley.geojson','pk-fairy-meadows.geojson','pk-karakoram-highway.geojson',
    'ro-transfagarasan.geojson','sa-asir.geojson','sa-edge-of-world.geojson',
    'se-high-coast.geojson','si-vrsic-pass.geojson','sv-ruta-flores.geojson','th-mae-hong-son.geojson',
    'tr-lycian-coast.geojson','tz-ngorongoro-serengeti.geojson','us-beartooth-highway.geojson',
    'us-blue-ridge-parkway.geojson','us-going-to-the-sun.geojson','us-million-dollar-highway.geojson',
    'us-natchez-trace.geojson','us-overseas-highway.geojson','us-pacific-coast-highway.geojson',
    'us-route-66.geojson','vn-ha-giang-loop.geojson','vn-hai-van-pass.geojson','za-chapmans-peak.geojson',
    'za-garden-route.geojson','za-panorama-route.geojson','za-sani-pass.geojson','za-swartberg-pass.geojson'
];

const poiFiles = [
    'ae.geojson','al.geojson','am.geojson','ao.geojson','ar.geojson','at.geojson','au.geojson','az.geojson',
    'ba.geojson','bd.geojson','be.geojson','bg.geojson','bh.geojson','bi.geojson',
    'bj.geojson','bo.geojson','br.geojson','bw.geojson','bz.geojson',
    'ca.geojson','cd.geojson','cg.geojson','ch.geojson','ci.geojson','cl.geojson',
    'cm.geojson','co.geojson','cr.geojson','cz.geojson',
    'de.geojson','dk.geojson',
    'ec.geojson','ee.geojson','eg.geojson','er.geojson','es.geojson','et.geojson',
    'fi.geojson','fr.geojson',
    'ga.geojson','gb.geojson','ge.geojson','gf.geojson','gh.geojson','gr.geojson','gt.geojson','gy.geojson',
    'hn.geojson','hr.geojson','hu.geojson',
    'id.geojson','ie.geojson','in.geojson','ir.geojson','is.geojson','it.geojson',
    'jo.geojson',
    'ke.geojson','kh.geojson','kw.geojson',
    'la.geojson','ls.geojson','lt.geojson','lu.geojson','lv.geojson',
    'ma.geojson','md.geojson','me.geojson','mk.geojson','mw.geojson','mx.geojson','my.geojson','mz.geojson',
    'na.geojson','ng.geojson','ni.geojson','nl.geojson','no.geojson','np.geojson','nz.geojson',
    'om.geojson',
    'pa.geojson','pe.geojson','pk.geojson','pl.geojson','pt.geojson','py.geojson',
    'qa.geojson',
    'ro.geojson','rs.geojson','rw.geojson',
    'sa.geojson','sd.geojson','se.geojson','sg.geojson','si.geojson','sk.geojson','sn.geojson',
    'sr.geojson','sv.geojson','sz.geojson',
    'th.geojson','tl.geojson','tr.geojson','tz.geojson',
    'ug.geojson','us.geojson','uy.geojson',
    'vn.geojson',
    'xk.geojson',
    'za.geojson','zm.geojson','zw.geojson'
];

const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v11',
    center: [40, 20],
    zoom: 1.5
});

map.on('load', async () => {
    // Load visited countries
    const visitedCountryCodes = await fetch('data/visited-countries.json').then(r => r.json());

    // Problematic countries to review (shown in red)
    const problemCountries = [
        'NG', 'CM', 'CD'   // Dangerous but crossable with planning
    ];

    // Add country boundaries
    map.addSource('countries', {
        type: 'vector',
        url: 'mapbox://mapbox.country-boundaries-v1'
    });

    map.addLayer({
        id: 'country-fills',
        type: 'fill',
        source: 'countries',
        'source-layer': 'country_boundaries',
        filter: [
            'any',
            ['==', 'all', ['get', 'worldview']],
            ['in', 'US', ['get', 'worldview']]
        ],
        paint: {
            'fill-color': [
                'case',
                ['in', ['get', 'iso_3166_1'], ['literal', problemCountries]],
                'rgba(231, 76, 60, 0.25)',
                ['in', ['get', 'iso_3166_1'], ['literal', visitedCountryCodes]],
                'rgba(39, 174, 96, 0.12)',
                'rgba(200, 200, 200, 0.05)'
            ],
            'fill-opacity': 1
        }
    }, 'admin-1-boundary-bg');

    // Load all scenic routes
    const routes = await Promise.all(
        routeFiles.map(async f => {
            try {
                const route = await fetch(`data/scenic-routes/${f}`).then(r => r.json());
                // Add routeId for local image lookup
                route.properties.routeId = f.replace('.geojson', '');
                return route;
            } catch (e) {
                console.warn(`Failed to load route: ${f}`, e);
                return null;
            }
        })
    ).then(r => r.filter(Boolean));

    // Combine into FeatureCollection
    const routesCollection = {
        type: 'FeatureCollection',
        features: routes
    };

    map.addSource('scenic-routes', {
        type: 'geojson',
        data: routesCollection
    });

    // Route lines - colored by rating
    map.addLayer({
        id: 'scenic-routes-line',
        type: 'line',
        source: 'scenic-routes',
        paint: {
            'line-color': [
                'match', ['get', 'rating'],
                5, '#e74c3c',
                4, '#e67e22',
                3, '#f39c12',
                2, '#f1c40f',
                '#f1c40f'
            ],
            'line-width': [
                'interpolate', ['linear'], ['zoom'],
                1, 1.5,
                5, 3,
                10, 5
            ],
            'line-opacity': 0.85
        }
    });

    // Hover highlight layer
    map.addLayer({
        id: 'scenic-routes-highlight',
        type: 'line',
        source: 'scenic-routes',
        paint: {
            'line-color': '#ffffff',
            'line-width': [
                'interpolate', ['linear'], ['zoom'],
                1, 4,
                5, 7,
                10, 10
            ],
            'line-opacity': ['case', ['boolean', ['feature-state', 'hover'], false], 0.8, 0]
        }
    }, 'scenic-routes-line');

    // Load all POIs
    const poiCollections = await Promise.all(
        poiFiles.map(async f => {
            try {
                return await fetch(`data/pois/${f}`).then(r => r.json());
            } catch (e) {
                return { type: 'FeatureCollection', features: [] };
            }
        })
    );

    // Combine all POI features
    const allPois = {
        type: 'FeatureCollection',
        features: poiCollections.flatMap(c => c.features || [])
    };

    map.addSource('pois', {
        type: 'geojson',
        data: allPois
    });

    // POI circles - colored by rating
    map.addLayer({
        id: 'pois-circle',
        type: 'circle',
        source: 'pois',
        paint: {
            'circle-color': [
                'match', ['get', 'rating'],
                5, '#e74c3c',
                4, '#e67e22',
                3, '#f39c12',
                2, '#f1c40f',
                '#f1c40f'
            ],
            'circle-radius': [
                'interpolate', ['linear'], ['zoom'],
                1, 3,
                5, 5,
                10, 8
            ],
            'circle-stroke-color': '#fff',
            'circle-stroke-width': [
                'interpolate', ['linear'], ['zoom'],
                1, 0.5,
                5, 1,
                10, 2
            ],
            'circle-opacity': 0.9
        }
    });

    // Load ferries
    fetch('data/ferries.geojson')
        .then(r => r.json())
        .then(data => {
            map.addSource('ferries', { type: 'geojson', data });
            map.addLayer({
                id: 'ferries-line',
                type: 'line',
                source: 'ferries',
                paint: {
                    'line-color': '#1a5276',
                    'line-width': 2,
                    'line-dasharray': [2, 2]
                }
            });
        });

    // Load shipping routes
    const shippingFiles = [
        'auckland-valparaiso.geojson',
        'bandar-abbas-karachi.geojson',
        'brisbane-auckland.geojson',
        'chittagong-laem-chabang.geojson',
        'darien-gap.geojson',
        'jb-jakarta.geojson',
        'seattle-southampton.geojson'
    ];
    Promise.all(shippingFiles.map(f => fetch(`data/shipping/${f}`).then(r => r.json())))
        .then(results => {
            const allShipping = {
                type: 'FeatureCollection',
                features: results.flatMap(r => r.features || [r])
            };
            map.addSource('shipping', { type: 'geojson', data: allShipping });
            map.addLayer({
                id: 'shipping-line',
                type: 'line',
                source: 'shipping',
                paint: {
                    'line-color': '#85c1e9',
                    'line-width': 2,
                    'line-dasharray': [4, 3]
                }
            });
        });

    // Load planned route (blue layer - added BEFORE scenic routes so they appear on top)
    fetch('data/planned-route.geojson')
        .then(r => r.json())
        .then(data => {
            map.addSource('planned-route', { type: 'geojson', data });

            // Main route line (summary only)
            map.addLayer({
                id: 'planned-route-line',
                type: 'line',
                source: 'planned-route',
                filter: ['==', ['get', 'type'], 'summary'],
                paint: {
                    'line-color': '#3498db',
                    'line-width': 4,
                    'line-opacity': 0.8
                }
            }, 'scenic-routes-highlight');

            // Segment highlight layer (shown on hover)
            map.addLayer({
                id: 'planned-route-segment-highlight',
                type: 'line',
                source: 'planned-route',
                filter: ['==', ['get', 'segmentIndex'], -1], // Initially hidden
                paint: {
                    'line-color': '#1a5276',
                    'line-width': 7,
                    'line-opacity': 1
                }
            }, 'scenic-routes-highlight');

            // Invisible wider line for segment hover detection
            map.addLayer({
                id: 'planned-route-segments-hover',
                type: 'line',
                source: 'planned-route',
                filter: ['!=', ['get', 'type'], 'summary'],
                paint: {
                    'line-color': 'transparent',
                    'line-width': 20
                }
            }, 'planned-route-line');

            // Segment info tooltip
            const segmentTooltip = document.createElement('div');
            segmentTooltip.id = 'segment-tooltip';
            segmentTooltip.style.cssText = 'position:absolute;background:#1a1a2e;color:#fff;padding:8px 12px;border-radius:6px;font-size:12px;pointer-events:none;display:none;z-index:100;max-width:280px;box-shadow:0 2px 8px rgba(0,0,0,0.3);';
            document.getElementById('map').appendChild(segmentTooltip);

            map.on('mousemove', 'planned-route-segments-hover', (e) => {
                if (e.features.length > 0) {
                    const props = e.features[0].properties;
                    if (props.distanceKm !== undefined) {
                        map.getCanvas().style.cursor = 'pointer';

                        // Highlight this segment
                        map.setFilter('planned-route-segment-highlight', [
                            'all',
                            ['==', ['get', 'part'], props.part],
                            ['==', ['get', 'segmentIndex'], props.segmentIndex]
                        ]);

                        segmentTooltip.innerHTML = `<strong>${props.label || props.from + ' â†’ ' + props.to}</strong><br>${props.distanceKm} km Â· ${props.durationHrs} hrs`;
                        segmentTooltip.style.display = 'block';
                        segmentTooltip.style.left = (e.point.x + 15) + 'px';
                        segmentTooltip.style.top = (e.point.y - 30) + 'px';
                    }
                }
            });

            map.on('mouseleave', 'planned-route-segments-hover', () => {
                map.getCanvas().style.cursor = '';
                segmentTooltip.style.display = 'none';
                // Hide highlight
                map.setFilter('planned-route-segment-highlight', ['==', ['get', 'segmentIndex'], -1]);
            });
        });

    // Interactivity
    let hoveredId = null;
    const routeInfo = document.getElementById('route-info');
    const routeName = document.getElementById('route-name');
    const routeCountry = document.getElementById('route-country');
    const routeRating = document.getElementById('route-rating');
    const routePhoto = document.getElementById('route-photo');
    const routeDescription = document.getElementById('route-description');

    // Position popup near click point
    function positionPopup(e) {
        const mapContainer = document.getElementById('map');
        const rect = mapContainer.getBoundingClientRect();
        const popupWidth = 320;
        const popupHeight = routeInfo.offsetHeight || 300;

        let left = e.point.x + 15;
        let top = e.point.y - 15;

        // Keep popup within viewport
        if (left + popupWidth > rect.width - 10) {
            left = e.point.x - popupWidth - 15;
        }
        if (top + popupHeight > rect.height - 10) {
            top = rect.height - popupHeight - 10;
        }
        if (top < 10) top = 10;
        if (left < 10) left = 10;

        routeInfo.style.left = left + 'px';
        routeInfo.style.top = top + 'px';
    }
    const routeClose = document.getElementById('route-close');
    const carouselPrev = document.getElementById('carousel-prev');
    const carouselNext = document.getElementById('carousel-next');
    const carouselDots = document.getElementById('carousel-dots');

    // Carousel state
    let currentRouteId = null;
    let currentPoiId = null; // {countryCode, safeName}
    let currentCustomImage = null; // for ferries/shipping
    let currentImageIndex = 0;
    let totalImages = 5;

    function sanitizeFilename(name) {
        return name.toLowerCase()
            .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // remove accents
            .replace(/Ã°/g, 'd').replace(/Ã¾/g, 'th') // Icelandic chars
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-|-$/g, '')
            .substring(0, 50);
    }

    function updateCarousel() {
        let imagePath;
        if (currentCustomImage) {
            imagePath = currentCustomImage;
        } else if (currentPoiId) {
            imagePath = `data/pois/images/${currentPoiId.countryCode}/${currentPoiId.safeName}-${currentImageIndex + 1}.webp`;
        } else if (currentRouteId) {
            imagePath = `data/scenic-routes/images/${currentRouteId}/${currentImageIndex + 1}.webp`;
        }
        routePhoto.src = imagePath;
        // Update dots
        const dots = carouselDots.querySelectorAll('.carousel-dot');
        dots.forEach((dot, i) => {
            dot.classList.toggle('active', i === currentImageIndex);
        });
    }

    function showCarouselControls(show) {
        carouselPrev.style.display = show ? 'flex' : 'none';
        carouselNext.style.display = show ? 'flex' : 'none';
        carouselDots.style.display = show ? 'flex' : 'none';
    }

    function createDots(count) {
        carouselDots.innerHTML = '';
        for (let i = 0; i < count; i++) {
            const dot = document.createElement('div');
            dot.className = 'carousel-dot' + (i === 0 ? ' active' : '');
            dot.addEventListener('click', () => {
                currentImageIndex = i;
                updateCarousel();
            });
            carouselDots.appendChild(dot);
        }
    }

    carouselPrev.addEventListener('click', () => {
        currentImageIndex = (currentImageIndex - 1 + totalImages) % totalImages;
        updateCarousel();
    });

    carouselNext.addEventListener('click', () => {
        currentImageIndex = (currentImageIndex + 1) % totalImages;
        updateCarousel();
    });

    routeClose.addEventListener('click', () => {
        routeInfo.style.display = 'none';
    });

    map.on('mousemove', 'scenic-routes-line', (e) => {
        map.getCanvas().style.cursor = 'pointer';
        if (e.features.length > 0) {
            if (hoveredId !== null) {
                map.setFeatureState({ source: 'scenic-routes', id: hoveredId }, { hover: false });
            }
            hoveredId = e.features[0].id;
            map.setFeatureState({ source: 'scenic-routes', id: hoveredId }, { hover: true });
        }
    });

    map.on('mouseleave', 'scenic-routes-line', () => {
        map.getCanvas().style.cursor = '';
        if (hoveredId !== null) {
            map.setFeatureState({ source: 'scenic-routes', id: hoveredId }, { hover: false });
        }
        hoveredId = null;
    });

    map.on('click', 'scenic-routes-line', (e) => {
        const props = e.features[0].properties;
        routeName.textContent = props.name;
        routeCountry.textContent = props.country;
        routeRating.textContent = 'â˜…'.repeat(props.rating);
        routeDescription.textContent = props.description || '';

        // Setup carousel for routes (with images and pagination)
        currentPoiId = null;
        currentCustomImage = null;
        currentRouteId = props.routeId;
        currentImageIndex = 0;
        totalImages = 5;
        createDots(totalImages);
        showCarouselControls(true);
        updateCarousel();
        document.getElementById('route-photo-container').style.display = 'block';

        routeInfo.style.display = 'block';
        positionPopup(e);
    });

    // POI click handler
    map.on('click', 'pois-circle', (e) => {
        const props = e.features[0].properties;
        routeName.textContent = props.name;
        routeCountry.textContent = props.country;
        routeRating.textContent = 'â˜…'.repeat(props.rating);
        routeDescription.textContent = props.description || '';

        // Single image for POIs (no pagination)
        currentRouteId = null;
        currentCustomImage = null;
        currentPoiId = {
            countryCode: props.countryCode.toLowerCase(),
            safeName: sanitizeFilename(props.name)
        };
        currentImageIndex = 0;
        totalImages = 1;
        showCarouselControls(false);
        updateCarousel();
        document.getElementById('route-photo-container').style.display = 'block';

        routeInfo.style.display = 'block';
        positionPopup(e);
    });

    // POI hover cursor
    map.on('mouseenter', 'pois-circle', () => {
        map.getCanvas().style.cursor = 'pointer';
    });

    map.on('mouseleave', 'pois-circle', () => {
        map.getCanvas().style.cursor = '';
    });

    // Ferry click handler
    map.on('click', 'ferries-line', (e) => {
        const props = e.features[0].properties;
        routeName.textContent = props.name;
        routeCountry.textContent = props.operator || 'Ferry';
        routeRating.textContent = 'â›´ï¸';

        let desc = [];
        if (props.duration) desc.push(`Duration: ${props.duration}`);
        if (props.frequency) desc.push(`Frequency: ${props.frequency}`);
        if (props.legs) desc.push(`Legs: ${props.legs}`);
        if (props.cost) desc.push(`Cost: ${props.cost}`);
        if (props.notes) desc.push(props.notes);
        routeDescription.textContent = desc.join(' â€¢ ') || '';

        // Show ferry image (single, no pagination)
        currentRouteId = null;
        currentPoiId = null;
        const ferryId = sanitizeFilename(props.name);
        currentCustomImage = `data/ferries/images/${ferryId}.webp`;
        currentImageIndex = 0;
        totalImages = 1;
        showCarouselControls(false);
        updateCarousel();
        document.getElementById('route-photo-container').style.display = 'block';

        routeInfo.style.display = 'block';
        positionPopup(e);
    });

    map.on('mouseenter', 'ferries-line', () => {
        map.getCanvas().style.cursor = 'pointer';
    });

    map.on('mouseleave', 'ferries-line', () => {
        map.getCanvas().style.cursor = '';
    });

    // Shipping click handler
    map.on('click', 'shipping-line', (e) => {
        const props = e.features[0].properties;
        routeName.textContent = props.name || 'Shipping Route';
        routeCountry.textContent = props.operator || 'Cargo Ship';
        routeRating.textContent = 'ðŸš¢';

        let desc = [];
        if (props.duration) desc.push(`Duration: ${props.duration}`);
        if (props.frequency) desc.push(`Frequency: ${props.frequency}`);
        if (props.cost) desc.push(`Cost: ${props.cost}`);
        if (props.notes) desc.push(props.notes);
        routeDescription.textContent = desc.join(' â€¢ ') || '';

        // Show shipping image (single, no pagination)
        currentRouteId = null;
        currentPoiId = null;
        const shippingId = sanitizeFilename(props.name || 'cargo-ship');
        currentCustomImage = `data/shipping/images/${shippingId}.webp`;
        currentImageIndex = 0;
        totalImages = 1;
        showCarouselControls(false);
        updateCarousel();
        document.getElementById('route-photo-container').style.display = 'block';

        routeInfo.style.display = 'block';
        positionPopup(e);
    });

    map.on('mouseenter', 'shipping-line', () => {
        map.getCanvas().style.cursor = 'pointer';
    });

    map.on('mouseleave', 'shipping-line', () => {
        map.getCanvas().style.cursor = '';
    });

    map.on('click', (e) => {
        const layers = ['scenic-routes-line', 'pois-circle', 'ferries-line', 'shipping-line'];
        const features = map.queryRenderedFeatures(e.point, { layers: layers.filter(l => map.getLayer(l)) });
        if (features.length === 0) {
            routeInfo.style.display = 'none';
        }
    });
});

map.addControl(new mapboxgl.NavigationControl());
</script>
</body>
</html>
