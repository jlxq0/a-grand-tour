<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>A Grand Tour - Route Map</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #legend {
            position: absolute;
            bottom: 30px;
            left: 10px;
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 13px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-width: 280px;
        }
        #legend h3 { margin: 0 0 10px 0; font-size: 14px; }
        .legend-item { display: flex; align-items: center; margin: 5px 0; }
        .legend-color { width: 20px; height: 4px; margin-right: 8px; border-radius: 2px; }
        .legend-dashed { border-top: 2px dashed; height: 0; }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 13px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-width: 300px;
        }
        #info h2 { margin: 0 0 5px 0; font-size: 16px; }
        #info p { margin: 5px 0; color: #666; }
        #controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        #controls label { display: block; margin: 5px 0; cursor: pointer; }
        .mapboxgl-popup-content {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 10px 15px;
        }
        .popup-title { font-weight: 600; font-size: 14px; }
        .popup-info { color: #666; font-size: 12px; margin-top: 4px; }
    </style>
</head>
<body>
<div id="map"></div>
<div id="info">
    <h2>A Grand Tour</h2>
    <p>15 years | 200,000 km | 100+ countries</p>
    <p>Feb 2027 – Aug 2042</p>
</div>
<div id="legend">
    <h3>Route Types</h3>
    <div class="legend-item"><div class="legend-color" style="background: linear-gradient(90deg, #e74c3c, #f1c40f, #2ecc71, #3498db, #9b59b6);"></div>Driving (by trip)</div>
    <div class="legend-item"><div class="legend-color legend-dashed" style="border-color: #3498db;"></div>Ferry</div>
    <div class="legend-item"><div class="legend-color legend-dashed" style="border-color: #9b59b6;"></div>Shipping</div>
</div>
<div id="controls">
    <strong>Show/Hide</strong>
    <label><input type="checkbox" id="toggle-driving" checked> Driving</label>
    <label><input type="checkbox" id="toggle-ferry" checked> Ferries</label>
    <label><input type="checkbox" id="toggle-shipping" checked> Shipping</label>
</div>

<script>
mapboxgl.accessToken = 'pk.eyJ1Ijoiamx4cTAiLCJhIjoiY21qd2QwOGRpNXVuNzNnb2txNmdkemd2ZyJ9.JpfheNv0aknnk-pbhNOGQg';

const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v11',
    center: [40, 20],
    zoom: 1.5
});

const colors = {
    ferry: '#3498db',
    shipping: '#9b59b6'
};

// 21 distinct colors for trips
const tripColors = [
    '#e74c3c', // Trip 1 - red
    '#e67e22', // Trip 2 - orange
    '#f1c40f', // Trip 3 - yellow
    '#2ecc71', // Trip 4 - green
    '#1abc9c', // Trip 5 - teal
    '#3498db', // Trip 6 - blue
    '#9b59b6', // Trip 7 - purple
    '#e91e63', // Trip 8 - pink
    '#00bcd4', // Trip 9 - cyan
    '#8bc34a', // Trip 10 - lime
    '#ff9800', // Trip 11 - amber
    '#795548', // Trip 12 - brown
    '#607d8b', // Trip 13 - blue-grey
    '#673ab7', // Trip 14 - deep purple
    '#009688', // Trip 15 - teal dark
    '#ff5722', // Trip 16 - deep orange
    '#4caf50', // Trip 17 - green dark
    '#2196f3', // Trip 18 - blue light
    '#9c27b0', // Trip 19 - purple dark
    '#cddc39', // Trip 20 - lime yellow
    '#f44336'  // Trip 21 - red dark
];

// Countries visited on the trip (using ISO 3166-1 alpha-2 codes for reliability)
const visitedCountryCodes = [
    'AL', 'AO', 'AR', 'AM', 'AU', 'AT', 'AZ',  // Albania, Angola, Argentina, Armenia, Australia, Austria, Azerbaijan
    'BD', 'BE', 'BZ', 'BJ', 'BO', 'BA', 'BW', 'BR', 'BG', 'BH',  // Bangladesh, Belgium, Belize, Benin, Bolivia, Bosnia, Botswana, Brazil, Bulgaria, Bahrain
    'KH', 'CM', 'CA', 'CL', 'CO', 'CG', 'CD', 'CR', 'HR', 'CZ', 'CH',  // Cambodia, Cameroon, Canada, Chile, Colombia, Congo, DRC, Costa Rica, Croatia, Czechia, Switzerland
    'DK', 'EC', 'EG', 'SV', 'EE', 'ET', 'ER', 'GQ',  // Denmark, Ecuador, Egypt, El Salvador, Estonia, Ethiopia, Eritrea, Equatorial Guinea
    'FI', 'FR', 'GA', 'GM', 'GE', 'DE', 'GH', 'GI', 'GR', 'GT', 'GW', 'GN', 'GY', 'GF',  // Finland, France, Gabon, Gambia, Georgia, Germany, Ghana, Gibraltar, Greece, Guatemala, Guinea-Bissau, Guinea, Guyana, French Guiana
    'HN', 'HU', 'IN', 'ID', 'IR', 'IE', 'IT', 'CI', 'LR',  // Honduras, Hungary, India, Indonesia, Iran, Ireland, Italy, Ivory Coast, Liberia
    'JO', 'KE', 'XK', 'KW', 'LA', 'LV', 'LT', 'LU', 'LS',  // Jordan, Kenya, Kosovo, Kuwait, Laos, Latvia, Lithuania, Luxembourg, Lesotho
    'MW', 'MY', 'MR', 'MX', 'MD', 'ME', 'MA', 'MZ',  // Malawi, Malaysia, Mauritania, Mexico, Moldova, Montenegro, Morocco, Mozambique
    'NA', 'NP', 'NL', 'NZ', 'NI', 'NG', 'MK', 'NO',  // Namibia, Nepal, Netherlands, New Zealand, Nicaragua, Nigeria, North Macedonia, Norway
    'OM', 'PK', 'PA', 'PY', 'PE', 'PL', 'PT', 'RO', 'RW', 'QA',  // Oman, Pakistan, Panama, Paraguay, Peru, Poland, Portugal, Romania, Rwanda, Qatar
    'SA', 'SN', 'RS', 'SL', 'SK', 'SI', 'ZA', 'ES', 'SD', 'SR', 'SE', 'SZ',  // Saudi Arabia, Senegal, Serbia, Sierra Leone, Slovakia, Slovenia, South Africa, Spain, Sudan, Suriname, Sweden, Eswatini
    'TZ', 'TH', 'TL', 'TG', 'TR',  // Tanzania, Thailand, Timor-Leste, Togo, Turkey
    'AE', 'UG', 'GB', 'US', 'VN', 'ZW', 'ZM', 'UY', 'EH', 'SG', 'BI'  // UAE, Uganda, UK, USA, Vietnam, Zimbabwe, Zambia, Uruguay, Western Sahara, Singapore, Burundi
];

// Load all GeoJSON data
async function loadData() {
    const [stops, roads, ferries, ...shipping] = await Promise.all([
        fetch('data/stops.geojson').then(r => r.json()),
        fetch('data/roads.geojson').then(r => r.json()),
        fetch('data/ferries.geojson').then(r => r.json()),
        fetch('data/shipping/jb-jakarta.geojson').then(r => r.json()),
        fetch('data/shipping/darien-gap.geojson').then(r => r.json()),
        fetch('data/shipping/chittagong-laem-chabang.geojson').then(r => r.json()),
        fetch('data/shipping/brisbane-auckland.geojson').then(r => r.json()),
        fetch('data/shipping/auckland-valparaiso.geojson').then(r => r.json()),
        fetch('data/shipping/seattle-southampton.geojson').then(r => r.json())
    ]);

    return {
        stops,
        roads,
        ferries,
        shipping: {
            'jb-jakarta': shipping[0],
            'darien-gap': shipping[1],
            'chittagong-laem-chabang': shipping[2],
            'brisbane-auckland': shipping[3],
            'auckland-valparaiso': shipping[4],
            'seattle-southampton': shipping[5]
        }
    };
}

map.on('load', async () => {
    const data = await loadData();

    // Add country fill layer (below everything else)
    map.addSource('countries', {
        type: 'vector',
        url: 'mapbox://mapbox.country-boundaries-v1'
    });

    map.addLayer({
        id: 'country-fills',
        type: 'fill',
        source: 'countries',
        'source-layer': 'country_boundaries',
        filter: [
            'all',
            ['==', ['get', 'disputed'], 'false'],
            ['any',
                ['==', 'all', ['get', 'worldview']],
                ['in', 'US', ['get', 'worldview']]
            ]
        ],
        paint: {
            'fill-color': [
                'case',
                ['in', ['get', 'iso_3166_1'], ['literal', visitedCountryCodes]],
                'rgba(39, 174, 96, 0.15)',  // subtle green for visited
                'rgba(231, 76, 60, 0.08)'   // subtle red for not visited
            ],
            'fill-opacity': 1
        }
    }, 'admin-1-boundary-bg');  // Place below admin boundaries

    // Add trip number to each road feature for coloring
    data.roads.features.forEach(f => {
        const match = f.properties.segment.match(/Trip (\d+)/);
        f.properties.trip = match ? parseInt(match[1]) : 1;
    });

    // Add road segments with trip-based coloring
    map.addSource('roads', { type: 'geojson', data: data.roads });
    map.addLayer({
        id: 'roads',
        type: 'line',
        source: 'roads',
        paint: {
            'line-color': [
                'match', ['get', 'trip'],
                1, tripColors[0], 2, tripColors[1], 3, tripColors[2], 4, tripColors[3],
                5, tripColors[4], 6, tripColors[5], 7, tripColors[6], 8, tripColors[7],
                9, tripColors[8], 10, tripColors[9], 11, tripColors[10], 12, tripColors[11],
                13, tripColors[12], 14, tripColors[13], 15, tripColors[14], 16, tripColors[15],
                17, tripColors[16], 18, tripColors[17], 19, tripColors[18], 20, tripColors[19],
                21, tripColors[20],
                '#27ae60' // default
            ],
            'line-width': 3,
            'line-opacity': 0.85
        }
    });

    // Add ferry routes (thinner than roads)
    map.addSource('ferries', { type: 'geojson', data: data.ferries });
    map.addLayer({
        id: 'ferries',
        type: 'line',
        source: 'ferries',
        paint: {
            'line-color': colors.ferry,
            'line-width': 1.5,
            'line-dasharray': [4, 3],
            'line-opacity': 0.8
        }
    });

    // Add shipping routes (thinner than roads)
    Object.keys(data.shipping).forEach(key => {
        map.addSource(`shipping-${key}`, { type: 'geojson', data: data.shipping[key] });
        map.addLayer({
            id: `shipping-${key}`,
            type: 'line',
            source: `shipping-${key}`,
            paint: {
                'line-color': colors.shipping,
                'line-width': 1.5,
                'line-dasharray': [6, 4],
                'line-opacity': 0.8
            }
        });
    });

    // Add markers for all stops (colored by trip)
    data.stops.features.forEach(stop => {
        const props = stop.properties;
        const tripColor = tripColors[props.trip - 1] || '#27ae60';

        const el = document.createElement('div');
        el.className = 'marker';
        el.style.width = '8px';
        el.style.height = '8px';
        el.style.backgroundColor = tripColor;
        el.style.borderRadius = '50%';
        el.style.border = '2px solid white';
        el.style.boxShadow = '0 1px 3px rgba(0,0,0,0.3)';
        el.style.cursor = 'pointer';

        const phase = props.trip <= 13 ? 'A' : 'B';
        const popup = new mapboxgl.Popup({ offset: 10 })
            .setHTML(`
                <div class="popup-title">${props.name}</div>
                <div class="popup-info">${props.country} · Trip ${props.trip} · Phase ${phase}</div>
            `);

        new mapboxgl.Marker(el)
            .setLngLat(stop.geometry.coordinates)
            .setPopup(popup)
            .addTo(map);
    });

    // Toggle controls
    document.getElementById('toggle-driving').addEventListener('change', (e) => {
        map.setLayoutProperty('roads', 'visibility', e.target.checked ? 'visible' : 'none');
        document.querySelectorAll('.marker').forEach(m => m.style.display = e.target.checked ? 'block' : 'none');
    });

    document.getElementById('toggle-ferry').addEventListener('change', (e) => {
        map.setLayoutProperty('ferries', 'visibility', e.target.checked ? 'visible' : 'none');
    });

    document.getElementById('toggle-shipping').addEventListener('change', (e) => {
        const visibility = e.target.checked ? 'visible' : 'none';
        Object.keys(data.shipping).forEach(key => {
            map.setLayoutProperty(`shipping-${key}`, 'visibility', visibility);
        });
    });
});

map.addControl(new mapboxgl.NavigationControl());
</script>
</body>
</html>
