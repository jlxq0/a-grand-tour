<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>A Grand Tour</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="One Family. One Land Cruiser. 100 Countries. A 17-year around-the-world overland expedition.">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* ============ CSS Variables for Theming ============ */
        :root {
            /* Light mode (default) */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #f5f5f5;
            --text-primary: #1a1a2e;
            --text-secondary: #333;
            --text-tertiary: #444;
            --text-muted: #666;
            --border-color: #e0e0e0;
            --border-light: #eee;
            --link-color: #3498db;
            --code-bg: #f5f5f5;
            --blockquote-bg: #f8f9fa;
            --table-stripe: #fafafa;
            --shadow-color: rgba(0,0,0,0.1);
            --overlay-bg: rgba(26, 26, 46, 0.95);
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a2e;
            --bg-secondary: #252542;
            --bg-tertiary: #2d2d4a;
            --text-primary: #f0f0f0;
            --text-secondary: #d0d0d0;
            --text-tertiary: #b0b0b0;
            --text-muted: #888;
            --border-color: #3d3d5c;
            --border-light: #333355;
            --link-color: #5dade2;
            --code-bg: #2d2d4a;
            --blockquote-bg: #252542;
            --table-stripe: #252542;
            --shadow-color: rgba(0,0,0,0.3);
            --overlay-bg: rgba(37, 37, 66, 0.95);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            height: 100vh;
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }

        .alpha-banner {
            background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
            color: white;
            text-align: center;
            padding: 10px 20px;
            font-size: 13px;
            font-weight: 500;
            letter-spacing: 0.3px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .alpha-banner span {
            opacity: 0.9;
        }

        .alpha-banner strong {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 4px;
            margin-right: 8px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .container {
            display: flex;
            height: calc(100vh - 42px);
        }

        /* Map Panel - Left Side */
        .map-panel {
            width: 50%;
            min-width: 300px;
            max-width: calc(100% - 300px);
            height: 100%;
            position: relative;
            flex-shrink: 0;
        }

        /* Resizable Divider */
        .resize-handle {
            width: 6px;
            background: var(--border-color);
            cursor: col-resize;
            position: relative;
            flex-shrink: 0;
            transition: background 0.2s;
        }

        .resize-handle:hover,
        .resize-handle.dragging {
            background: #3498db;
        }

        .resize-handle::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 30px;
            background: var(--text-muted);
            border-radius: 1px;
            opacity: 0.5;
        }

        .resize-handle:hover::after,
        .resize-handle.dragging::after {
            background: #fff;
            opacity: 1;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .map-overlay {
            position: absolute;
            top: 15px;
            left: 15px;
            background: #fff;
            color: #333;
            padding: 12px 15px;
            border-radius: 4px;
            z-index: 10;
            max-width: 240px;
            box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] .map-overlay {
            background: rgba(26, 26, 46, 0.95);
            color: #fff;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.1);
        }

        .map-overlay h1 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .map-overlay p {
            font-size: 11px;
            color: #666;
            font-style: italic;
        }

        [data-theme="dark"] .map-overlay p {
            color: #aaa;
        }

        .legend {
            position: absolute;
            bottom: 40px;
            left: 15px;
            background: #fff;
            color: #333;
            padding: 10px 12px;
            border-radius: 4px;
            font-size: 11px;
            z-index: 10;
            box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] .legend {
            background: rgba(26, 26, 46, 0.95);
            color: #fff;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.1);
        }

        .legend h4 {
            margin: 0 0 6px 0;
            font-size: 11px;
            font-weight: 600;
            color: #333;
        }

        [data-theme="dark"] .legend h4 {
            color: #aaa;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 3px 0;
        }

        .legend-line {
            width: 16px;
            height: 3px;
            margin-right: 6px;
            border-radius: 1px;
        }

        .legend-line-dashed {
            width: 16px;
            height: 0;
            margin-right: 6px;
            border-top: 3px dashed #2471a3;
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
            border: 1px solid #fff;
            box-shadow: 0 0 2px rgba(0,0,0,0.3);
        }

        .legend-fill {
            width: 16px;
            height: 10px;
            margin-right: 6px;
            border-radius: 2px;
            border: 1px solid rgba(231, 76, 60, 0.4);
        }

        /* Map Controls - Match Mapbox UI style */
        .map-controls {
            position: absolute;
            top: 100px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 0;
            z-index: 10;
        }

        .map-control-btn {
            background: #fff;
            color: #333;
            border: none;
            width: 29px;
            height: 29px;
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.1s;
            box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
            padding: 0;
        }

        .map-control-btn:first-child {
            border-radius: 4px 4px 0 0;
        }

        .map-control-btn:last-child {
            border-radius: 0 0 4px 4px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        .map-control-btn:hover {
            background: #f0f0f0;
        }

        .map-control-btn.active {
            background: #3498db;
            color: #fff;
        }

        .map-control-btn svg {
            width: 18px;
            height: 18px;
        }

        .map-control-btn span {
            display: none;
        }

        /* Dark mode for custom map controls */
        [data-theme="dark"] .map-control-btn {
            background: #1a1a2e;
            color: #fff;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.1);
        }

        [data-theme="dark"] .map-control-btn:last-child {
            border-top-color: rgba(255,255,255,0.1);
        }

        [data-theme="dark"] .map-control-btn:hover {
            background: #252542;
        }

        [data-theme="dark"] .map-control-btn.active {
            background: #3498db;
            color: #fff;
        }

        /* Dark mode for Mapbox built-in controls */
        [data-theme="dark"] .mapboxgl-ctrl-group {
            background: #1a1a2e;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.1);
        }

        [data-theme="dark"] .mapboxgl-ctrl-group button {
            background-color: #1a1a2e;
        }

        [data-theme="dark"] .mapboxgl-ctrl-group button + button {
            border-top-color: rgba(255,255,255,0.1);
        }

        [data-theme="dark"] .mapboxgl-ctrl-group button:hover {
            background-color: #252542;
        }

        [data-theme="dark"] .mapboxgl-ctrl button .mapboxgl-ctrl-icon {
            filter: invert(1);
        }

        [data-theme="dark"] .mapboxgl-ctrl-attrib {
            background-color: rgba(26, 26, 46, 0.8);
            color: #aaa;
        }

        [data-theme="dark"] .mapboxgl-ctrl-attrib a {
            color: #5dade2;
        }

        /* Content Panel - Right Side */
        .content-panel {
            flex: 1;
            min-width: 300px;
            height: 100%;
            background: var(--bg-primary);
            overflow-y: auto;
            transition: background 0.3s;
        }

        .content-wrapper {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 50px 80px;
        }

        /* Navigation */
        .nav {
            position: sticky;
            top: 0;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-light);
            padding: 12px 50px;
            margin: 0 -50px 30px;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            transition: background 0.3s, border-color 0.3s;
        }

        .nav a {
            color: var(--link-color);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
        }

        .nav a:hover {
            text-decoration: underline;
        }

        .nav-menu {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .nav-menu a {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            transition: background 0.2s;
            color: var(--link-color);
        }

        .nav-menu a:hover {
            background: var(--bg-secondary);
            text-decoration: none;
        }

        .nav-menu a.active {
            background: #3498db;
            color: white;
        }

        /* Trips dropdown */
        .nav-dropdown {
            position: relative;
        }

        .nav-dropdown-toggle {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--link-color);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .nav-dropdown-toggle:hover {
            background: var(--bg-secondary);
        }

        .nav-dropdown-toggle.active {
            background: #3498db;
            color: white;
        }

        .nav-dropdown-toggle svg {
            width: 12px;
            height: 12px;
            transition: transform 0.2s;
        }

        .nav-dropdown.open .nav-dropdown-toggle svg {
            transform: rotate(180deg);
        }

        .nav-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 20px var(--shadow-color);
            min-width: 280px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 200;
            display: none;
            margin-top: 4px;
        }

        .nav-dropdown.open .nav-dropdown-menu {
            display: block;
        }

        .nav-dropdown-menu a {
            display: block;
            padding: 10px 14px;
            font-size: 13px;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-light);
        }

        .nav-dropdown-menu a:last-child {
            border-bottom: none;
        }

        .nav-dropdown-menu a:hover {
            background: var(--bg-secondary);
            text-decoration: none;
        }

        .nav-dropdown-menu a.active {
            background: rgba(52, 152, 219, 0.1);
            color: #3498db;
        }

        .nav-dropdown-menu .trip-name {
            font-weight: 500;
        }

        .nav-dropdown-menu .trip-route {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .nav-separator {
            color: var(--border-color);
            margin: 0 4px;
        }

        /* Theme toggle in nav */
        .theme-toggle {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            background: var(--bg-tertiary);
        }

        /* Markdown Styles */
        .markdown-content h1 {
            font-size: 2.2em;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text-primary);
            border-bottom: 3px solid #3498db;
            padding-bottom: 15px;
        }

        .markdown-content h2 {
            font-size: 1.6em;
            font-weight: 600;
            margin: 40px 0 20px;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 10px;
        }

        .markdown-content h3 {
            font-size: 1.3em;
            font-weight: 600;
            margin: 30px 0 15px;
            color: var(--text-secondary);
        }

        .markdown-content h3.day-heading-link {
            cursor: pointer;
            color: var(--link-color);
            transition: color 0.2s ease;
        }

        .markdown-content h3.day-heading-link:hover {
            color: #1a5276;
            text-decoration: underline;
        }

        [data-theme="dark"] .markdown-content h3.day-heading-link:hover {
            color: #85c1e9;
        }

        .markdown-content h4 {
            font-size: 1.1em;
            font-weight: 600;
            margin: 25px 0 10px;
            color: var(--text-tertiary);
        }

        .markdown-content p {
            line-height: 1.7;
            margin: 15px 0;
            color: var(--text-tertiary);
        }

        .markdown-content a {
            color: var(--link-color);
            text-decoration: none;
        }

        .markdown-content a:hover {
            text-decoration: underline;
        }

        .markdown-content ul, .markdown-content ol {
            margin: 15px 0;
            padding-left: 25px;
            color: var(--text-tertiary);
        }

        .markdown-content li {
            line-height: 1.7;
            margin: 8px 0;
        }

        .markdown-content code {
            background: var(--code-bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .markdown-content pre {
            background: linear-gradient(135deg, #1a1a2e 0%, #2d2d4a 100%);
            color: #e0e0e0;
            padding: 20px 24px;
            border-radius: 12px;
            overflow-x: auto;
            margin: 20px 0;
            border-left: 4px solid #3498db;
            font-size: 13px;
            line-height: 1.8;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        [data-theme="dark"] .markdown-content pre {
            background: linear-gradient(135deg, #0d0d1a 0%, #1a1a2e 100%);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .markdown-content pre code {
            background: none;
            padding: 0;
            color: inherit;
            font-size: inherit;
        }

        .markdown-content blockquote {
            border-left: 4px solid #3498db;
            border-radius: 0 8px 8px 0;
            margin: 12px 0;
            padding: 12px 16px;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            color: var(--text-secondary);
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        .markdown-content blockquote strong {
            color: var(--text-primary);
            display: block;
            margin-bottom: 4px;
            font-size: 0.95em;
        }

        .markdown-content blockquote p {
            margin: 0;
            color: var(--text-tertiary);
            font-size: 0.9em;
            line-height: 1.6;
        }

        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.95em;
        }

        .markdown-content th, .markdown-content td {
            border: 1px solid var(--border-color);
            padding: 12px 15px;
            text-align: left;
            color: var(--text-tertiary);
        }

        .markdown-content th {
            background: var(--bg-tertiary);
            font-weight: 600;
            color: var(--text-secondary);
        }

        .markdown-content tr:nth-child(even) {
            background: var(--table-stripe);
        }

        .markdown-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 4px 15px var(--shadow-color);
        }

        .markdown-content hr {
            border: none;
            border-top: 2px solid var(--border-light);
            margin: 40px 0;
        }

        /* Trip Stats Card */
        .markdown-content .trip-stats {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border-radius: 12px;
            padding: 20px 24px;
            margin: 20px 0;
            box-shadow: 0 4px 15px var(--shadow-color);
            border: 1px solid var(--border-light);
        }

        .markdown-content .trip-stats ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .markdown-content .trip-stats li {
            margin: 0;
            padding: 8px 12px;
            background: var(--bg-primary);
            border-radius: 8px;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .markdown-content .trip-stats li strong {
            color: var(--text-primary);
        }

        /* Clickable place links in text */
        .place-link {
            color: var(--link-color);
            cursor: pointer;
            border-bottom: 1px dotted var(--link-color);
            transition: all 0.2s ease;
        }

        .place-link:hover {
            background: rgba(52, 152, 219, 0.15);
            border-bottom-style: solid;
        }

        .place-link.highlighted {
            background: rgba(52, 152, 219, 0.3);
            animation: pulse-highlight 1s ease-out;
        }

        @keyframes pulse-highlight {
            0% { background: rgba(52, 152, 219, 0.5); }
            100% { background: rgba(52, 152, 219, 0.3); }
        }

        @keyframes map-pulse {
            0% {
                transform: scale(0.5);
                opacity: 1;
            }
            50% {
                transform: scale(1.5);
                opacity: 0.8;
            }
            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        /* Map highlight pulse for POIs */
        .mapboxgl-popup-tip,
        .mapboxgl-popup-content {
            animation: none;
        }

        /* Route info popup */
        #route-info {
            position: absolute;
            background: #fff;
            border-radius: 12px;
            font-size: 14px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
            display: none;
            width: 300px;
            overflow: hidden;
            z-index: 100;
        }

        #route-photo-container {
            position: relative;
            width: 100%;
            height: 160px;
            background: #222;
        }

        #route-photo {
            width: 100%;
            height: 160px;
            object-fit: cover;
        }

        .carousel-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            padding: 0;
        }

        #carousel-prev { left: 8px; }
        #carousel-next { right: 8px; }

        #carousel-dots {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5px;
        }

        .carousel-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            cursor: pointer;
        }

        .carousel-dot.active { background: white; }

        #route-content {
            padding: 12px 15px;
        }

        #route-info h3 {
            margin: 0 0 4px 0;
            font-size: 15px;
            font-weight: 600;
        }

        #route-info .country {
            color: #666;
            margin: 0 0 6px 0;
            font-size: 12px;
        }

        #route-info .rating {
            color: #f39c12;
            margin: 0 0 8px 0;
            font-size: 14px;
        }

        #route-info .description {
            color: #333;
            margin: 0;
            line-height: 1.5;
            font-size: 12px;
        }

        #route-close {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 16px;
            line-height: 22px;
            text-align: center;
        }

        /* Segment tooltip */
        #segment-tooltip {
            position: absolute;
            background: #1a1a2e;
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            display: none;
            z-index: 100;
            max-width: 260px;
        }

        /* Loading state */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #888;
        }

        /* Footer nav */
        .footer-nav {
            margin-top: 60px;
            padding-top: 30px;
            border-top: 1px solid #eee;
            text-align: center;
        }

        .footer-nav a {
            color: #3498db;
            text-decoration: none;
            font-weight: 500;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .map-panel { width: 45%; }
            .content-panel { width: 55%; }
        }

        @media (max-width: 900px) {
            .container { flex-direction: column; }
            .map-panel { width: 100%; height: 40vh; }
            .content-panel { width: 100%; height: 60vh; }
        }
    </style>
</head>
<body>
    <div class="alpha-banner">
        <strong>Alpha</strong>
        <span>Early planning stage for a dream trip — may never actually happen like this!</span>
    </div>
    <div class="container">
        <!-- Map Panel -->
        <div class="map-panel">
            <div id="map"></div>
            <div class="map-overlay">
                <h1>A Grand Tour</h1>
                <p>One Family. One Land Cruiser. 100 Countries.</p>
            </div>
            <div class="legend">
                <h4>Legend</h4>
                <div class="legend-item"><div class="legend-line" style="background: #2471a3;"></div> Planned route</div>
                <div class="legend-item"><div class="legend-line-dashed"></div> Ferry / Ship</div>
                <div class="legend-item"><div class="legend-line" style="background: #f1c40f;"></div> Scenic route</div>
                <div class="legend-item"><div class="legend-dot" style="background: #e74c3c;"></div> Point of interest</div>
                <div class="legend-item"><div class="legend-fill" style="background: rgba(231, 76, 60, 0.25);"></div> Problematic</div>
            </div>

            <!-- Map Controls -->
            <div class="map-controls">
                <button class="map-control-btn" id="style-toggle" title="Style: Terrain (click to change)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M2 20l7-7 4 4 9-11"/>
                        <path d="M2 20h20"/>
                    </svg>
                </button>
                <button class="map-control-btn" id="theme-toggle-map" title="Toggle Dark/Light Mode">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="5"/>
                        <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                    </svg>
                </button>
            </div>

            <!-- Route Info Popup -->
            <div id="route-info">
                <button id="route-close">&times;</button>
                <div id="route-photo-container">
                    <img id="route-photo" src="" alt="">
                    <button class="carousel-btn" id="carousel-prev">&lsaquo;</button>
                    <button class="carousel-btn" id="carousel-next">&rsaquo;</button>
                    <div id="carousel-dots"></div>
                </div>
                <div id="route-content">
                    <h3 id="route-name"></h3>
                    <p class="country" id="route-country"></p>
                    <p class="rating" id="route-rating"></p>
                    <p class="description" id="route-description"></p>
                </div>
            </div>
            <div id="segment-tooltip"></div>
        </div>

        <!-- Resize Handle -->
        <div class="resize-handle" id="resize-handle"></div>

        <!-- Content Panel -->
        <div class="content-panel">
            <div class="content-wrapper">
                <nav class="nav" id="nav"></nav>
                <div class="markdown-content" id="content">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>
    </div>

<script>
// Global index of places for text linking (populated after map data loads)
let placeIndex = {};
let routeData = null; // Store route data globally for segment lookup
let allPoisData = null;
let allRoutesData = null;

// Page configuration
const pages = {
    '': { file: 'README.md', title: 'Overview', short: 'Overview', isTrip: false },
    'trip01': { file: 'TRIP01.md', title: 'Trip 1: Dubai to Delhi', short: 'Trip 1', route: 'Dubai → Delhi', isTrip: true },
    'trip02': { file: 'TRIP02.md', title: 'Trip 2: Delhi to Chittagong', short: 'Trip 2', route: 'Delhi → Chittagong', isTrip: true },
    'trip03': { file: 'TRIP03.md', title: 'Trip 3: Bangkok to Singapore', short: 'Trip 3', route: 'Bangkok → Singapore', isTrip: true },
    'trip04': { file: 'TRIP04.md', title: 'Trip 4: Singapore to Dili', short: 'Trip 4', route: 'Singapore → Dili', isTrip: true },
    'trip05': { file: 'TRIP05.md', title: 'Trip 5: Darwin to Townsville', short: 'Trip 5', route: 'Darwin → Townsville', isTrip: true },
    'trip06': { file: 'TRIP06.md', title: 'Trip 6: Auckland to Christchurch', short: 'Trip 6', route: 'Auckland → Christchurch', isTrip: true },
    'trip07': { file: 'TRIP07.md', title: 'Trip 7: Valparaíso to Cartagena', short: 'Trip 7', route: 'Valparaíso → Cartagena', isTrip: true },
    'trip08': { file: 'TRIP08.md', title: 'Trip 8: Panama to Oaxaca', short: 'Trip 8', route: 'Panama → Oaxaca', isTrip: true },
    'trip09': { file: 'TRIP09.md', title: 'Trip 9: Oaxaca to Los Angeles', short: 'Trip 9', route: 'Oaxaca → Los Angeles', isTrip: true },
    'trip10': { file: 'TRIP10.md', title: 'Trip 10: Los Angeles to Houston', short: 'Trip 10', route: 'Los Angeles → Houston', isTrip: true },
    'trip11': { file: 'TRIP11.md', title: 'Trip 11: Houston to Toronto', short: 'Trip 11', route: 'Houston → Toronto', isTrip: true },
    'trip12': { file: 'TRIP12.md', title: 'Trip 12: Toronto to Jacksonville', short: 'Trip 12', route: 'Toronto → Jacksonville', isTrip: true }
};

let currentPage = null;

// Parse hash - returns { page, anchor }
function parseHash() {
    const hash = window.location.hash.slice(1);
    if (!hash) return { page: '', anchor: null };

    // Check if it's a page hash
    if (pages[hash]) return { page: hash, anchor: null };

    // Check if it's page:anchor format (e.g., trip01:day-5)
    if (hash.includes(':')) {
        const [page, anchor] = hash.split(':');
        if (pages[page]) return { page, anchor };
    }

    // Otherwise it's an anchor on the current page
    return { page: currentPage, anchor: hash };
}

// Update navigation menu
function updateNav(activePage) {
    const nav = document.getElementById('nav');
    const trips = Object.entries(pages).filter(([k, v]) => v.isTrip);
    const isOnTrip = pages[activePage]?.isTrip;
    const activeTrip = isOnTrip ? pages[activePage] : null;

    // Build trips dropdown items
    const tripItems = trips.map(([key, config]) => {
        const activeClass = key === activePage ? 'active' : '';
        return `<a href="#${key}" class="${activeClass}">
            <div class="trip-name">${config.short}: ${config.route}</div>
        </a>`;
    }).join('');

    const dropdownLabel = activeTrip ? activeTrip.short : 'Trips';
    const dropdownActive = isOnTrip ? 'active' : '';

    nav.innerHTML = `
        <div class="nav-menu">
            <a href="#" class="${activePage === '' ? 'active' : ''}">Overview</a>
            <div class="nav-dropdown" id="trips-dropdown">
                <button class="nav-dropdown-toggle ${dropdownActive}">
                    ${dropdownLabel}
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 9l6 6 6-6"/>
                    </svg>
                </button>
                <div class="nav-dropdown-menu">
                    ${tripItems}
                </div>
            </div>
        </div>
    `;

    // Dropdown toggle
    const dropdown = document.getElementById('trips-dropdown');
    const toggle = dropdown.querySelector('.nav-dropdown-toggle');
    toggle.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdown.classList.toggle('open');
    });

    // Close on click outside
    document.addEventListener('click', () => {
        dropdown.classList.remove('open');
    });

    // Close on item click
    dropdown.querySelectorAll('.nav-dropdown-menu a').forEach(a => {
        a.addEventListener('click', () => {
            dropdown.classList.remove('open');
        });
    });
}

// Scroll to anchor
function scrollToAnchor(anchor) {
    if (!anchor) return;

    // Wait a tick for DOM to update
    setTimeout(() => {
        const element = document.getElementById(anchor);
        if (element) {
            const contentPanel = document.querySelector('.content-panel');
            const navHeight = document.querySelector('.nav').offsetHeight;
            const elementTop = element.offsetTop - navHeight - 40;
            contentPanel.scrollTo({ top: elementTop, behavior: 'smooth' });
        }
    }, 100);
}

// Load and render markdown
async function loadContent(page, anchor = null) {
    const contentEl = document.getElementById('content');
    const config = pages[page];

    // Only reload if page changed
    if (page !== currentPage) {
        currentPage = page;
        contentEl.innerHTML = '<div class="loading">Loading...</div>';
        updateNav(page);
        document.title = config.title + ' | A Grand Tour';

        try {
            const response = await fetch(config.file);
            if (!response.ok) throw new Error('Failed to load');

            let markdown = await response.text();

            // Convert internal links (TRIP01.md -> #trip01)
            markdown = markdown.replace(/\[([^\]]+)\]\(TRIP0?(\d+)\.md\)/g, '[$1](#trip0$2)');

            const html = marked.parse(markdown);
            contentEl.innerHTML = html;

            // Add IDs to headings for anchor links
            contentEl.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach(heading => {
                if (!heading.id) {
                    heading.id = heading.textContent
                        .toLowerCase()
                        .replace(/[^\w\s-]/g, '')
                        .replace(/\s+/g, '-')
                        .replace(/^-+|-+$/g, '');
                }
            });

            // Handle clicks on internal anchor links
            contentEl.querySelectorAll('a[href^="#"]').forEach(link => {
                link.addEventListener('click', (e) => {
                    const href = link.getAttribute('href').slice(1);

                    // If it's a page link, let normal navigation handle it
                    if (pages[href]) return;

                    // Otherwise it's an anchor link - scroll to it
                    e.preventDefault();
                    scrollToAnchor(href);

                    // Update URL without triggering hashchange
                    history.pushState(null, '', `#${currentPage}${currentPage ? ':' : ''}${href}`);
                });
            });

            // Link place names to map (if place index is built)
            if (Object.keys(placeIndex).length > 0) {
                linkPlacesToMap(contentEl);
            }

            // Link day headings to route highlights (for trip pages)
            if (config.isTrip) {
                linkDaysToRoute(contentEl, page);
            }

            // Scroll to top if no anchor
            if (!anchor) {
                document.querySelector('.content-panel').scrollTop = 0;
            }
        } catch (e) {
            contentEl.innerHTML = `<p style="color: #e74c3c;">Error loading content: ${e.message}</p>`;
        }
    }

    // Scroll to anchor if specified
    if (anchor) {
        scrollToAnchor(anchor);
    }
}

// Handle navigation
window.addEventListener('hashchange', () => {
    const { page, anchor } = parseHash();
    loadContent(page, anchor);
});

// Handle popstate for back/forward
window.addEventListener('popstate', () => {
    const { page, anchor } = parseHash();
    loadContent(page, anchor);
});

// Initial load
const { page: initialPage, anchor: initialAnchor } = parseHash();
loadContent(initialPage, initialAnchor);

// ============ MAP CODE ============
mapboxgl.accessToken = 'pk.eyJ1Ijoiamx4cTAiLCJhIjoiY21qd2QwOGRpNXVuNzNnb2txNmdkemd2ZyJ9.JpfheNv0aknnk-pbhNOGQg';

// Theme and settings management
let isDarkMode = localStorage.getItem('theme') === 'dark' ||
    (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches);
// Map style modes: terrain (default), map, satellite
const mapStyleModes = ['terrain', 'map', 'satellite'];
let currentStyleMode = localStorage.getItem('mapStyleMode') || 'terrain';

// Apply initial theme
if (isDarkMode) {
    document.documentElement.setAttribute('data-theme', 'dark');
    document.getElementById('theme-toggle-map').classList.add('active');
}

const mapStyles = {
    terrain: {
        light: 'mapbox://styles/mapbox/outdoors-v12',
        dark: 'mapbox://styles/mapbox/outdoors-v12'  // Use outdoors for terrain in both modes
    },
    map: {
        light: 'mapbox://styles/mapbox/light-v11',
        dark: 'mapbox://styles/mapbox/dark-v11'
    },
    satellite: {
        light: 'mapbox://styles/mapbox/satellite-streets-v12',
        dark: 'mapbox://styles/mapbox/satellite-streets-v12'
    }
};

function getMapStyle() {
    return mapStyles[currentStyleMode][isDarkMode ? 'dark' : 'light'];
}

const routeFiles = [
    'ae-jebel-hafeet.geojson','ae-khor-fakkan.geojson','al-llogara-pass.geojson','ar-calchaqui.geojson',
    'ar-el-chalten.geojson','ar-paso-caracoles.geojson','ar-ruta-40.geojson','ar-seven-lakes.geojson',
    'at-grossglockner.geojson','au-gibb-river-road.geojson','au-great-alpine-road.geojson',
    'au-great-ocean-road.geojson','au-nullarbor.geojson','au-outback-way.geojson','bo-death-road.geojson',
    'bo-salar-uyuni.geojson','br-serra-rio-rastro.geojson','bz-hummingbird-highway.geojson',
    'ca-cabot-trail.geojson','ca-icefields-parkway.geojson','ca-sea-to-sky.geojson','ch-furka-pass.geojson',
    'ch-grimsel-pass.geojson','ch-susten-pass.geojson','cl-carretera-austral.geojson',
    'cl-general-carrera.geojson','cn-tianmen-mountain.geojson','cr-braulio-carrillo.geojson',
    'cr-cerro-muerte.geojson','de-alpine-road.geojson','de-black-forest.geojson','de-romantic-road.geojson',
    'de-wine-route.geojson','ec-avenue-volcanoes.geojson','es-sa-calobra.geojson','et-simien-mountains.geojson',
    'fi-archipelago-trail.geojson','fr-col-de-turini.geojson','fr-combe-laval.geojson','fr-grandes-alpes.geojson',
    'fr-lacets-montvernier.geojson','fr-route-napoleon.geojson','fr-verdon-gorge.geojson',
    'gb-bealach-na-ba.geojson','gb-causeway-coastal.geojson','gb-nc500.geojson','gr-vikos-gorge.geojson',
    'gt-lake-atitlan.geojson','hr-adriatic-highway.geojson','hr-gorski-kotar.geojson','id-mount-bromo.geojson',
    'in-kochi-munnar.geojson','in-manali-leh.geojson','in-spiti-valley.geojson','in-srinagar-leh.geojson',
    'is-ring-road.geojson','it-amalfi-coast.geojson','it-dolomites.geojson','it-stelvio-pass.geojson',
    'it-strada-della-forra.geojson','jo-kings-highway.geojson','jo-wadi-rum.geojson','ma-dades-gorge.geojson',
    'ma-tizi-ntichka.geojson','ma-todra-gorge.geojson','mx-baja-highway-1.geojson','mx-chiapas.geojson',
    'mx-copper-canyon.geojson','mx-devils-backbone.geojson','mx-oaxaca-coast.geojson',
    'mx-pacific-coast-200.geojson','mx-valle-guadalupe.geojson','my-cameron-highlands.geojson',
    'na-fish-river-canyon.geojson','na-sossusvlei-skeleton.geojson','no-atlantic-road.geojson',
    'no-geirangerfjord.geojson','no-lofoten.geojson','no-trollstigen.geojson','np-kathmandu-pokhara.geojson',
    'nz-arthurs-pass.geojson','nz-crown-range.geojson','nz-forgotten-world.geojson','nz-milford-road.geojson',
    'nz-queen-charlotte.geojson','nz-queenstown-glenorchy.geojson','om-jebel-akhdar.geojson',
    'om-jebel-shams.geojson','om-muscat-salalah.geojson','om-wadi-bani-awf.geojson','pa-darien.geojson',
    'pe-sacred-valley.geojson','pk-fairy-meadows.geojson','pk-karakoram-highway.geojson',
    'ro-transfagarasan.geojson','sa-asir.geojson','sa-edge-of-world.geojson',
    'se-high-coast.geojson','si-vrsic-pass.geojson','sv-ruta-flores.geojson','th-mae-hong-son.geojson',
    'tr-lycian-coast.geojson','tz-ngorongoro-serengeti.geojson','us-beartooth-highway.geojson',
    'us-blue-ridge-parkway.geojson','us-going-to-the-sun.geojson','us-million-dollar-highway.geojson',
    'us-natchez-trace.geojson','us-overseas-highway.geojson','us-pacific-coast-highway.geojson',
    'us-route-66.geojson','vn-ha-giang-loop.geojson','vn-hai-van-pass.geojson','za-chapmans-peak.geojson',
    'za-garden-route.geojson','za-panorama-route.geojson','za-sani-pass.geojson','za-swartberg-pass.geojson'
];

const poiFiles = [
    'ae.geojson','al.geojson','am.geojson','ao.geojson','ar.geojson','at.geojson','au.geojson','az.geojson',
    'ba.geojson','bd.geojson','be.geojson','bg.geojson','bh.geojson','bi.geojson','bj.geojson','bo.geojson',
    'br.geojson','bw.geojson','bz.geojson','ca.geojson','cd.geojson','cg.geojson','ch.geojson','ci.geojson',
    'cl.geojson','cm.geojson','co.geojson','cr.geojson','cz.geojson','de.geojson','dk.geojson','ec.geojson',
    'ee.geojson','eg.geojson','er.geojson','es.geojson','et.geojson','fi.geojson','fr.geojson','ga.geojson',
    'gb.geojson','ge.geojson','gf.geojson','gh.geojson','gr.geojson','gt.geojson','gy.geojson','hn.geojson',
    'hr.geojson','hu.geojson','id.geojson','ie.geojson','in.geojson','ir.geojson','is.geojson','it.geojson',
    'jo.geojson','ke.geojson','kh.geojson','kw.geojson','la.geojson','ls.geojson','lt.geojson','lu.geojson',
    'lv.geojson','ma.geojson','md.geojson','me.geojson','mk.geojson','mw.geojson','mx.geojson','my.geojson',
    'mz.geojson','na.geojson','ng.geojson','ni.geojson','nl.geojson','no.geojson','np.geojson','nz.geojson',
    'om.geojson','pa.geojson','pe.geojson','pk.geojson','pl.geojson','pt.geojson','py.geojson','qa.geojson',
    'ro.geojson','rs.geojson','rw.geojson','sa.geojson','sd.geojson','se.geojson','sg.geojson','si.geojson',
    'sk.geojson','sn.geojson','sr.geojson','sv.geojson','sz.geojson','th.geojson','tl.geojson','tr.geojson',
    'tz.geojson','ug.geojson','us.geojson','uy.geojson','vn.geojson','xk.geojson','za.geojson','zm.geojson',
    'zw.geojson'
];

const map = new mapboxgl.Map({
    container: 'map',
    style: getMapStyle(),
    center: [40, 20],
    zoom: 1.5,
    projection: 'globe'
});

// Globe atmosphere effect
map.on('style.load', () => {
    map.setFog({
        color: isDarkMode ? 'rgb(20, 20, 40)' : 'rgb(220, 230, 240)',
        'high-color': isDarkMode ? 'rgb(30, 30, 60)' : 'rgb(180, 200, 230)',
        'horizon-blend': 0.02,
        'space-color': isDarkMode ? 'rgb(10, 10, 20)' : 'rgb(200, 210, 230)',
        'star-intensity': isDarkMode ? 0.6 : 0.1
    });
});

// Map style toggle functionality
function setupTerrain() {
    // Always add DEM source
    if (!map.getSource('mapbox-dem')) {
        map.addSource('mapbox-dem', {
            type: 'raster-dem',
            url: 'mapbox://mapbox.mapbox-terrain-dem-v1',
            tileSize: 512,
            maxzoom: 14
        });
    }
    // Enable 3D terrain for terrain and satellite modes
    if (currentStyleMode === 'terrain' || currentStyleMode === 'satellite') {
        map.setTerrain({ source: 'mapbox-dem', exaggeration: 1.5 });
    } else {
        map.setTerrain(null);
    }
    updateStyleButton();
}

function updateStyleButton() {
    const btn = document.getElementById('style-toggle');
    const icons = {
        terrain: '<path d="M2 20l7-7 4 4 9-11"/><path d="M2 20h20"/>',
        map: '<rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M3 15h18M9 3v18M15 3v18"/>',
        satellite: '<circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>'
    };
    btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">${icons[currentStyleMode]}</svg>`;
    btn.title = `Style: ${currentStyleMode.charAt(0).toUpperCase() + currentStyleMode.slice(1)} (click to change)`;
}

function cycleMapStyle() {
    const currentIndex = mapStyleModes.indexOf(currentStyleMode);
    currentStyleMode = mapStyleModes[(currentIndex + 1) % mapStyleModes.length];
    localStorage.setItem('mapStyleMode', currentStyleMode);
    map.setStyle(getMapStyle());
}

document.getElementById('style-toggle').addEventListener('click', cycleMapStyle);

// Dark mode toggle functionality
function toggleTheme() {
    isDarkMode = !isDarkMode;
    localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');

    document.documentElement.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
    document.getElementById('theme-toggle-map').classList.toggle('active', isDarkMode);

    // Change map style
    map.setStyle(getMapStyle());
}

document.getElementById('theme-toggle-map').addEventListener('click', toggleTheme);

// Re-add layers after style change
map.on('style.load', async () => {
    // Re-apply fog
    map.setFog({
        color: isDarkMode ? 'rgb(20, 20, 40)' : 'rgb(220, 230, 240)',
        'high-color': isDarkMode ? 'rgb(30, 30, 60)' : 'rgb(180, 200, 230)',
        'horizon-blend': 0.02,
        'space-color': isDarkMode ? 'rgb(10, 10, 20)' : 'rgb(200, 210, 230)',
        'star-intensity': isDarkMode ? 0.6 : 0.1
    });

    // Re-setup terrain
    setupTerrain();

    // Re-add all data layers
    await addDataLayers();
});

async function addDataLayers() {
    // Skip if layers already exist
    if (map.getSource('countries')) return;

    // Load visited countries
    const visitedCountryCodes = await fetch('data/visited-countries.json').then(r => r.json());
    const problemCountries = ['NG', 'CM', 'CD'];

    map.addSource('countries', {
        type: 'vector',
        url: 'mapbox://mapbox.country-boundaries-v1'
    });

    map.addLayer({
        id: 'country-fills',
        type: 'fill',
        source: 'countries',
        'source-layer': 'country_boundaries',
        filter: ['any', ['==', 'all', ['get', 'worldview']], ['in', 'US', ['get', 'worldview']]],
        paint: {
            'fill-color': [
                'case',
                ['in', ['get', 'iso_3166_1'], ['literal', problemCountries]], 'rgba(231, 76, 60, 0.25)',
                ['in', ['get', 'iso_3166_1'], ['literal', visitedCountryCodes]], 'rgba(39, 174, 96, 0.12)',
                'rgba(200, 200, 200, 0.05)'
            ],
            'fill-opacity': 1
        }
    }, 'admin-1-boundary-bg');

    // Load scenic routes
    const routes = await Promise.all(
        routeFiles.map(async f => {
            try {
                const route = await fetch(`data/scenic-routes/${f}`).then(r => r.json());
                route.properties.routeId = f.replace('.geojson', '');
                return route;
            } catch (e) { return null; }
        })
    ).then(r => r.filter(Boolean));

    const routesCollection = { type: 'FeatureCollection', features: routes };
    allRoutesData = routesCollection;  // Store globally for place index
    map.addSource('scenic-routes', { type: 'geojson', data: routesCollection });

    map.addLayer({
        id: 'scenic-routes-line',
        type: 'line',
        source: 'scenic-routes',
        paint: {
            'line-color': '#f1c40f',  // Bright yellow for scenic routes
            'line-width': ['interpolate', ['linear'], ['zoom'], 1, 1.5, 5, 3, 10, 5],
            'line-opacity': 0.85
        }
    });

    map.addLayer({
        id: 'scenic-routes-highlight',
        type: 'line',
        source: 'scenic-routes',
        paint: {
            'line-color': '#ffffff',
            'line-width': ['interpolate', ['linear'], ['zoom'], 1, 4, 5, 7, 10, 10],
            'line-opacity': ['case', ['boolean', ['feature-state', 'hover'], false], 0.8, 0]
        }
    }, 'scenic-routes-line');

    // Load POIs
    const poiCollections = await Promise.all(
        poiFiles.map(async f => {
            try { return await fetch(`data/pois/${f}`).then(r => r.json()); }
            catch (e) { return { type: 'FeatureCollection', features: [] }; }
        })
    );

    const allPois = { type: 'FeatureCollection', features: poiCollections.flatMap(c => c.features || []) };
    allPoisData = allPois;  // Store globally for place index
    map.addSource('pois', { type: 'geojson', data: allPois });

    map.addLayer({
        id: 'pois-circle',
        type: 'circle',
        source: 'pois',
        paint: {
            'circle-color': '#e74c3c',  // Bright red for POIs
            'circle-radius': ['interpolate', ['linear'], ['zoom'], 1, 3, 5, 5, 10, 8],
            'circle-stroke-color': '#fff',
            'circle-stroke-width': ['interpolate', ['linear'], ['zoom'], 1, 0.5, 5, 1, 10, 2],
            'circle-opacity': 0.9
        }
    });

    // Load ferries
    fetch('data/ferries.geojson').then(r => r.json()).then(data => {
        map.addSource('ferries', { type: 'geojson', data });
        map.addLayer({
            id: 'ferries-line',
            type: 'line',
            source: 'ferries',
            paint: { 'line-color': '#1a5276', 'line-width': 2, 'line-dasharray': [2, 2] }
        });
    });

    // Load shipping
    const shippingFiles = ['auckland-valparaiso.geojson', 'bandar-abbas-karachi.geojson', 'brisbane-auckland.geojson',
        'chittagong-laem-chabang.geojson', 'darien-gap.geojson', 'jb-jakarta.geojson', 'jacksonville-southampton.geojson'];
    Promise.all(shippingFiles.map(f => fetch(`data/shipping/${f}`).then(r => r.json()))).then(results => {
        const allShipping = { type: 'FeatureCollection', features: results.flatMap(r => r.features || [r]) };
        map.addSource('shipping', { type: 'geojson', data: allShipping });
        map.addLayer({
            id: 'shipping-line',
            type: 'line',
            source: 'shipping',
            paint: { 'line-color': '#85c1e9', 'line-width': 2, 'line-dasharray': [4, 3] }
        });
    });

    // Load planned route
    fetch('data/planned-route.geojson').then(r => r.json()).then(data => {
        routeData = data; // Store globally for segment lookup
        map.addSource('planned-route', { type: 'geojson', data });

        map.addLayer({
            id: 'planned-route-line',
            type: 'line',
            source: 'planned-route',
            filter: ['==', ['get', 'type'], 'summary'],
            paint: { 'line-color': '#2471a3', 'line-width': 4, 'line-opacity': 0.9 }  // Darker blue, more prominent
        }, 'scenic-routes-highlight');

        map.addLayer({
            id: 'planned-route-segment-highlight',
            type: 'line',
            source: 'planned-route',
            filter: ['==', ['get', 'segmentIndex'], -1],
            paint: { 'line-color': '#1a5276', 'line-width': 7, 'line-opacity': 1 }
        }, 'scenic-routes-highlight');

        map.addLayer({
            id: 'planned-route-segments-hover',
            type: 'line',
            source: 'planned-route',
            filter: ['!=', ['get', 'type'], 'summary'],
            paint: { 'line-color': 'transparent', 'line-width': 20 }
        }, 'planned-route-line');

        const segmentTooltip = document.getElementById('segment-tooltip');

        // Map part numbers to trip info
        const tripInfo = {
            1: { name: 'Trip 1', page: 'trip01', subtitle: 'Dubai → Delhi' },
            2: { name: 'Trip 2', page: 'trip02', subtitle: 'Delhi → Chittagong' },
            3: { name: 'Trip 3', page: 'trip03', subtitle: 'Bangkok → Singapore' },
            4: { name: 'Trip 4', page: 'trip04', subtitle: 'Singapore → Dili' },
            5: { name: 'Trip 5', page: 'trip05', subtitle: 'Darwin → Townsville' },
            6: { name: 'Trip 6', page: 'trip06', subtitle: 'Auckland → Christchurch' }
        };

        // Map Trip 1 segment indices to day numbers
        const trip1DayMapping = {
            0: { day: 2, anchor: 'day-2-dubai-khor-fakkan' },
            1: { day: 3, anchor: 'day-3-khor-fakkan-musandam-fjords' },
            2: { day: 4, anchor: 'day-4-musandam-sohar' },
            3: { day: 7, anchor: 'day-7-muscat-wadi-shab' },
            4: { day: 8, anchor: 'day-8-wadi-shab-nizwa' },
            5: { day: 9, anchor: 'day-9-nizwa-jebel-akhdar' },
            6: { day: 10, anchor: 'day-10-jebel-akhdar-jebel-shams' },
            7: { day: 10, anchor: 'day-10-jebel-akhdar-jebel-shams' },
            8: { day: 12, anchor: 'day-12-13-jebel-shams-salalah' },
            9: { day: 15, anchor: 'day-15-16-salalah-empty-quarter' },
            10: { day: 17, anchor: 'day-17-empty-quarter-liwa' },
            11: { day: 18, anchor: 'day-18-liwa-abu-dhabi' },
            12: { day: 19, anchor: 'day-19-abu-dhabi-inland-sea-qatar' },
            13: { day: 20, anchor: 'day-20-inland-sea-doha' },
            14: { day: 22, anchor: 'day-22-doha-bahrain' },
            15: { day: 23, anchor: 'day-23-bahrain-dammam' },
            16: { day: 24, anchor: 'day-24-25-dammam-riyadh' },
            17: { day: 24, anchor: 'day-24-25-dammam-riyadh' },
            18: { day: 24, anchor: 'day-24-25-dammam-riyadh' },
            19: { day: 26, anchor: 'day-26-riyadh-kuwait-city' },
            20: { day: 28, anchor: 'day-28-kuwait-basra' },
            21: { day: 29, anchor: 'day-29-basra-ziggurat-of-ur' },
            22: { day: 30, anchor: 'day-30-basra-ahvaz-iran' },
            23: { day: 30, anchor: 'day-30-basra-ahvaz-iran' },
            24: { day: 31, anchor: 'day-31-ahvaz-kermanshah' },
            25: { day: 32, anchor: 'day-32-kermanshah-tehran' },
            26: { day: 34, anchor: 'day-34-tehran-isfahan' },
            27: { day: 37, anchor: 'day-37-isfahan-yazd' },
            28: { day: 39, anchor: 'day-39-yazd-shiraz' },
            29: { day: 40, anchor: 'day-40-shiraz-persepolis' },
            30: { day: 41, anchor: 'day-41-shiraz-bandar-abbas' },
            31: { day: 48, anchor: 'day-48-49-karachi-multan' },
            32: { day: 50, anchor: 'day-50-multan-lahore' },
            33: { day: 52, anchor: 'day-52-lahore-islamabad' },
            34: { day: 54, anchor: 'day-54-islamabad-abbottabad-besham' },
            35: { day: 54, anchor: 'day-54-islamabad-abbottabad-besham' },
            36: { day: 55, anchor: 'day-55-besham-chilas' },
            37: { day: 56, anchor: 'day-56-chilas-gilgit' },
            38: { day: 58, anchor: 'day-58-gilgit-karimabad-hunza' },
            39: { day: 61, anchor: 'day-61-karimabad-khunjerab-pass' },
            40: { day: 61, anchor: 'day-61-karimabad-khunjerab-pass' },
            41: { day: 62, anchor: 'day-62-66-return-kkh' },
            42: { day: 63, anchor: 'day-62-66-return-kkh' },
            43: { day: 64, anchor: 'day-62-66-return-kkh' },
            44: { day: 65, anchor: 'day-62-66-return-kkh' },
            45: { day: 66, anchor: 'day-62-66-return-kkh' },
            46: { day: 67, anchor: 'day-67-lahore-amritsar' },
            47: { day: 69, anchor: 'day-69-amritsar-chandigarh' },
            48: { day: 70, anchor: 'day-70-71-chandigarh-manali' },
            49: { day: 72, anchor: 'day-72-73-manali-leh' },
            50: { day: 76, anchor: 'day-76-77-leh-manali-return' },
            51: { day: 78, anchor: 'day-78-manali-kaza-spiti' },
            52: { day: 79, anchor: 'day-79-kaza-shimla' },
            53: { day: 81, anchor: 'day-81-shimla-delhi' }
        };

        // Map Trip 2 segment indices to day numbers (segments now start from 0)
        const trip2DayMapping = {
            0: { day: 2, anchor: 'day-2-delhi-agra-september-2-2027' },
            1: { day: 4, anchor: 'day-4-agra-jaipur-september-4-2027' },
            2: { day: 6, anchor: 'day-6-jaipur-jodhpur-september-6-2027' },
            3: { day: 8, anchor: 'day-8-jodhpur-jaisalmer' },
            4: { day: 10, anchor: 'day-10-jaisalmer-udaipur' },
            5: { day: 12, anchor: 'day-12-udaipur-rann-of-kutch' },
            6: { day: 14, anchor: 'day-14-rann-of-kutch-ahmedabad' },
            7: { day: 15, anchor: 'day-15-ahmedabad-mumbai' },
            8: { day: 17, anchor: 'day-17-mumbai-goa' },
            9: { day: 20, anchor: 'day-20-goa-hampi' },
            10: { day: 22, anchor: 'day-22-hampi-bangalore' },
            11: { day: 23, anchor: 'day-23-bangalore-kochi' },
            12: { day: 25, anchor: 'day-25-kochi-munnar' },
            13: { day: 27, anchor: 'day-27-munnar-alleppey' },
            14: { day: 28, anchor: 'day-28-alleppey-madurai' },
            15: { day: 30, anchor: 'day-30-madurai-pondicherry' },
            16: { day: 31, anchor: 'day-31-pondicherry-chennai' },
            17: { day: 32, anchor: 'day-32-chennai-visakhapatnam' },
            18: { day: 32, anchor: 'day-32-chennai-visakhapatnam' },
            19: { day: 33, anchor: 'day-33-continue-visakhapatnam' },
            20: { day: 34, anchor: 'day-34-visakhapatnam-kolkata' },
            21: { day: 37, anchor: 'day-37-kolkata-varanasi' },
            22: { day: 40, anchor: 'day-40-varanasi-kathmandu' },
            23: { day: 42, anchor: 'day-42-kathmandu-bhaktapur' },
            24: { day: 43, anchor: 'day-43-bhaktapur-nagarkot' },
            25: { day: 44, anchor: 'day-44-nagarkot-pokhara' },
            26: { day: 47, anchor: 'day-47-pokhara-lumbini' },
            27: { day: 48, anchor: 'day-48-49-lumbini-chitwan' },
            28: { day: 50, anchor: 'day-50-chitwan-paharpur' },
            29: { day: 52, anchor: 'day-52-paharpur-dhaka' },
            30: { day: 54, anchor: 'day-54-55-dhaka-sundarbans' },
            31: { day: 56, anchor: 'day-56-sundarbans-khulna' },
            32: { day: 57, anchor: 'day-57-khulna-dhaka' },
            33: { day: 58, anchor: 'day-58-dhaka-coxs-bazar' },
            34: { day: 60, anchor: 'day-60-coxs-bazar-chittagong' }
        };

        function getDayInfo(part, segmentIndex) {
            if (part === 1 && trip1DayMapping[segmentIndex]) {
                return trip1DayMapping[segmentIndex];
            }
            if (part === 2 && trip2DayMapping[segmentIndex]) {
                return trip2DayMapping[segmentIndex];
            }
            return null;
        }

        map.on('mousemove', 'planned-route-segments-hover', (e) => {
            if (e.features.length > 0) {
                const props = e.features[0].properties;
                if (props.distanceKm !== undefined) {
                    map.getCanvas().style.cursor = 'pointer';
                    map.setFilter('planned-route-segment-highlight', [
                        'all', ['==', ['get', 'part'], props.part], ['==', ['get', 'segmentIndex'], props.segmentIndex]
                    ]);
                    const trip = tripInfo[props.part] || { name: `Part ${props.part}` };
                    const dayInfo = getDayInfo(props.part, props.segmentIndex);
                    const tripDayText = dayInfo ? `${trip.name}: Day ${dayInfo.day}` : trip.name;
                    segmentTooltip.innerHTML = `
                        <strong>${props.label || props.from + ' → ' + props.to}</strong><br>
                        ${props.distanceKm} km · ${props.durationHrs} hrs<br>
                        <span style="color: #3498db; font-size: 11px;">${tripDayText}</span>
                    `;
                    segmentTooltip.style.display = 'block';
                    segmentTooltip.style.left = (e.point.x + 15) + 'px';
                    segmentTooltip.style.top = (e.point.y - 30) + 'px';
                }
            }
        });

        map.on('mouseleave', 'planned-route-segments-hover', () => {
            map.getCanvas().style.cursor = '';
            segmentTooltip.style.display = 'none';
            map.setFilter('planned-route-segment-highlight', ['==', ['get', 'segmentIndex'], -1]);
        });

        // Click on route segment to navigate to trip and day
        map.on('click', 'planned-route-segments-hover', (e) => {
            if (e.features.length > 0) {
                const props = e.features[0].properties;
                const trip = tripInfo[props.part];
                const dayInfo = getDayInfo(props.part, props.segmentIndex);
                if (trip && trip.page) {
                    // Navigate to trip page, then scroll to day anchor
                    window.location.hash = trip.page;
                    if (dayInfo) {
                        // Wait for content to load, then scroll to anchor with proper offset
                        setTimeout(() => {
                            scrollToAnchor(dayInfo.anchor);
                        }, 300);
                    }
                }
            }
        });
    });

    // Interactivity
    let hoveredId = null;
    const routeInfo = document.getElementById('route-info');
    const routeName = document.getElementById('route-name');
    const routeCountry = document.getElementById('route-country');
    const routeRating = document.getElementById('route-rating');
    const routePhoto = document.getElementById('route-photo');
    const routeDescription = document.getElementById('route-description');
    const routeClose = document.getElementById('route-close');
    const carouselPrev = document.getElementById('carousel-prev');
    const carouselNext = document.getElementById('carousel-next');
    const carouselDots = document.getElementById('carousel-dots');

    let currentRouteId = null, currentPoiId = null, currentCustomImage = null;
    let currentImageIndex = 0, totalImages = 5;

    function sanitizeFilename(name) {
        return name.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '')
            .replace(/ð/g, 'd').replace(/þ/g, 'th').replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '').substring(0, 50);
    }

    function updateCarousel() {
        let imagePath;
        if (currentCustomImage) imagePath = currentCustomImage;
        else if (currentPoiId) imagePath = `data/pois/images/${currentPoiId.countryCode}/${currentPoiId.safeName}-1.webp`;
        else if (currentRouteId) imagePath = `data/scenic-routes/images/${currentRouteId}/${currentImageIndex + 1}.webp`;
        routePhoto.src = imagePath;
        carouselDots.querySelectorAll('.carousel-dot').forEach((dot, i) => dot.classList.toggle('active', i === currentImageIndex));
    }

    function showCarouselControls(show) {
        carouselPrev.style.display = show ? 'flex' : 'none';
        carouselNext.style.display = show ? 'flex' : 'none';
        carouselDots.style.display = show ? 'flex' : 'none';
    }

    function createDots(count) {
        carouselDots.innerHTML = '';
        for (let i = 0; i < count; i++) {
            const dot = document.createElement('div');
            dot.className = 'carousel-dot' + (i === 0 ? ' active' : '');
            dot.addEventListener('click', () => { currentImageIndex = i; updateCarousel(); });
            carouselDots.appendChild(dot);
        }
    }

    function positionPopup(e) {
        const rect = document.getElementById('map').getBoundingClientRect();
        let left = e.point.x + 15, top = e.point.y - 15;
        if (left + 300 > rect.width - 10) left = e.point.x - 315;
        if (top + 300 > rect.height - 10) top = rect.height - 310;
        if (top < 10) top = 10;
        if (left < 10) left = 10;
        routeInfo.style.left = left + 'px';
        routeInfo.style.top = top + 'px';
    }

    carouselPrev.addEventListener('click', () => { currentImageIndex = (currentImageIndex - 1 + totalImages) % totalImages; updateCarousel(); });
    carouselNext.addEventListener('click', () => { currentImageIndex = (currentImageIndex + 1) % totalImages; updateCarousel(); });
    routeClose.addEventListener('click', () => { routeInfo.style.display = 'none'; });

    // Close info panel when map moves (drag, zoom, fly)
    map.on('movestart', () => {
        routeInfo.style.display = 'none';
    });

    map.on('mousemove', 'scenic-routes-line', (e) => {
        map.getCanvas().style.cursor = 'pointer';
        if (e.features.length > 0) {
            if (hoveredId !== null) map.setFeatureState({ source: 'scenic-routes', id: hoveredId }, { hover: false });
            hoveredId = e.features[0].id;
            map.setFeatureState({ source: 'scenic-routes', id: hoveredId }, { hover: true });
        }
    });

    map.on('mouseleave', 'scenic-routes-line', () => {
        map.getCanvas().style.cursor = '';
        if (hoveredId !== null) map.setFeatureState({ source: 'scenic-routes', id: hoveredId }, { hover: false });
        hoveredId = null;
    });

    map.on('click', 'scenic-routes-line', (e) => {
        const props = e.features[0].properties;
        routeName.textContent = props.name;
        routeCountry.textContent = props.country;
        routeRating.textContent = '★'.repeat(props.rating);
        routeDescription.textContent = props.description || '';
        currentPoiId = null; currentCustomImage = null; currentRouteId = props.routeId;
        currentImageIndex = 0; totalImages = 5;
        createDots(totalImages); showCarouselControls(true); updateCarousel();
        document.getElementById('route-photo-container').style.display = 'block';
        routeInfo.style.display = 'block'; positionPopup(e);
        scrollToPlaceInContent(props.name);
    });

    map.on('click', 'pois-circle', (e) => {
        const props = e.features[0].properties;
        routeName.textContent = props.name;
        routeCountry.textContent = props.country;
        routeRating.textContent = '★'.repeat(props.rating);
        routeDescription.textContent = props.description || '';
        currentRouteId = null; currentCustomImage = null;
        currentPoiId = { countryCode: props.countryCode.toLowerCase(), safeName: sanitizeFilename(props.name) };
        currentImageIndex = 0; totalImages = 1;
        showCarouselControls(false); updateCarousel();
        document.getElementById('route-photo-container').style.display = 'block';
        routeInfo.style.display = 'block'; positionPopup(e);
        scrollToPlaceInContent(props.name);
    });

    map.on('mouseenter', 'pois-circle', () => { map.getCanvas().style.cursor = 'pointer'; });
    map.on('mouseleave', 'pois-circle', () => { map.getCanvas().style.cursor = ''; });

    map.on('click', 'ferries-line', (e) => {
        const props = e.features[0].properties;
        routeName.textContent = props.name;
        routeCountry.textContent = props.operator || 'Ferry';
        routeRating.textContent = '⛴️';
        let desc = ['We travel on board with the vehicle'];
        if (props.duration) desc.push(`Duration: ${props.duration}`);
        if (props.cost) desc.push(`Cost: ${props.cost}`);
        routeDescription.textContent = desc.join(' • ');
        currentRouteId = null; currentPoiId = null;
        currentCustomImage = `data/ferries/images/${sanitizeFilename(props.name)}.webp`;
        showCarouselControls(false); updateCarousel();
        document.getElementById('route-photo-container').style.display = 'block';
        routeInfo.style.display = 'block'; positionPopup(e);
        scrollToPlaceInContent(props.name);
    });

    map.on('mouseenter', 'ferries-line', () => { map.getCanvas().style.cursor = 'pointer'; });
    map.on('mouseleave', 'ferries-line', () => { map.getCanvas().style.cursor = ''; });

    map.on('click', 'shipping-line', (e) => {
        const props = e.features[0].properties;
        routeName.textContent = props.name || 'Shipping Route';
        routeCountry.textContent = props.operator || 'Cargo Ship';
        routeRating.textContent = '🚢';
        let desc = ['Vehicle shipped separately - we fly'];
        if (props.duration) desc.push(`Duration: ${props.duration}`);
        if (props.cost) desc.push(`Cost: ${props.cost}`);
        routeDescription.textContent = desc.join(' • ');
        currentRouteId = null; currentPoiId = null;
        currentCustomImage = `data/shipping/images/${sanitizeFilename(props.name || 'cargo-ship')}.webp`;
        showCarouselControls(false); updateCarousel();
        document.getElementById('route-photo-container').style.display = 'block';
        routeInfo.style.display = 'block'; positionPopup(e);
        scrollToPlaceInContent(props.name);
    });

    map.on('mouseenter', 'shipping-line', () => { map.getCanvas().style.cursor = 'pointer'; });
    map.on('mouseleave', 'shipping-line', () => { map.getCanvas().style.cursor = ''; });

    map.on('click', (e) => {
        const layers = ['scenic-routes-line', 'pois-circle', 'ferries-line', 'shipping-line'];
        const features = map.queryRenderedFeatures(e.point, { layers: layers.filter(l => map.getLayer(l)) });
        if (features.length === 0) routeInfo.style.display = 'none';
    });

    // Build place index after all data is loaded
    buildPlaceIndex();
    // Re-link places if content is already loaded
    const contentEl = document.getElementById('content');
    if (contentEl && !contentEl.querySelector('.loading')) {
        linkPlacesToMap(contentEl);
    }
}

// ============ PLACE INDEX & CLICK-TO-HIGHLIGHT ============

// Scroll to a place mention in the content panel (called when clicking map features)
function scrollToPlaceInContent(placeName) {
    if (!placeName) return false;

    // Find all place-link elements that match this name
    const placeLinks = document.querySelectorAll('.place-link');
    let targetLink = null;

    for (const link of placeLinks) {
        if (link.dataset.place === placeName.toLowerCase() ||
            link.textContent.toLowerCase() === placeName.toLowerCase()) {
            targetLink = link;
            break;
        }
    }

    if (!targetLink) {
        console.log('Place not found in content:', placeName);
        return false;
    }

    // Remove previous highlights
    document.querySelectorAll('.place-link.highlighted').forEach(el => {
        el.classList.remove('highlighted');
    });

    // Highlight this link
    targetLink.classList.add('highlighted');

    // Scroll to the element in the content panel
    const contentPanel = document.querySelector('.content-panel');
    const navHeight = document.querySelector('.nav').offsetHeight;
    const targetTop = targetLink.offsetTop - navHeight - 100;

    contentPanel.scrollTo({
        top: Math.max(0, targetTop),
        behavior: 'smooth'
    });

    return true;
}

function buildPlaceIndex() {
    placeIndex = {};

    // Add POIs to index
    if (allPoisData && allPoisData.features) {
        allPoisData.features.forEach(feature => {
            const name = feature.properties.name;
            const coords = feature.geometry.coordinates;
            if (name && coords) {
                const placeData = {
                    type: 'poi',
                    name: name,
                    coords: coords,
                    properties: feature.properties
                };
                // Store with full name
                placeIndex[name.toLowerCase()] = placeData;

                // Also store with short name (without parenthetical like "Amber Fort (Jaipur)" -> "Amber Fort")
                const shortName = name.replace(/\s*\([^)]+\)\s*$/, '').trim();
                if (shortName !== name && shortName.length > 0) {
                    placeIndex[shortName.toLowerCase()] = placeData;
                }
            }
        });
    }

    // Add scenic routes to index
    if (allRoutesData && allRoutesData.features) {
        allRoutesData.features.forEach(feature => {
            const name = feature.properties.name;
            const coords = feature.geometry.coordinates;
            if (name && coords && coords.length > 0) {
                // Get center point of route
                const midIndex = Math.floor(coords.length / 2);
                const centerCoord = coords[midIndex];
                placeIndex[name.toLowerCase()] = {
                    type: 'route',
                    name: name,
                    coords: centerCoord,
                    allCoords: coords,
                    properties: feature.properties
                };
            }
        });
    }

    console.log(`Place index built with ${Object.keys(placeIndex).length} places`);
}

// Highlight a place on the map
function highlightPlace(placeName) {
    const place = placeIndex[placeName.toLowerCase()];
    if (!place) {
        console.log('Place not found:', placeName);
        return false;
    }

    // Fly to the location
    map.flyTo({
        center: place.coords,
        zoom: place.type === 'poi' ? 10 : 8,
        duration: 1500
    });

    // Create a temporary highlight marker
    const highlightEl = document.createElement('div');
    highlightEl.className = 'map-highlight-pulse';
    highlightEl.style.cssText = `
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(52, 152, 219, 0.4);
        border: 3px solid #3498db;
        animation: map-pulse 2s ease-out;
        pointer-events: none;
    `;

    const marker = new mapboxgl.Marker({ element: highlightEl })
        .setLngLat(place.coords)
        .addTo(map);

    // Remove marker after animation
    setTimeout(() => marker.remove(), 2500);

    return true;
}

// Post-process rendered markdown to add clickable place links
function linkPlacesToMap(contentEl) {
    if (Object.keys(placeIndex).length === 0) return;

    // Build a list of place names sorted by length (longer first to avoid partial matches)
    // Use the INDEX KEYS (which include short names like "Amber Fort") not just the full .name property
    const placeNames = Object.keys(placeIndex)
        .sort((a, b) => b.length - a.length);

    // Process text nodes in the content
    const walker = document.createTreeWalker(
        contentEl,
        NodeFilter.SHOW_TEXT,
        {
            acceptNode: function(node) {
                // Skip if parent is already a link, code, or place-link
                const parent = node.parentElement;
                if (parent.tagName === 'A' || parent.tagName === 'CODE' ||
                    parent.tagName === 'PRE' || parent.classList.contains('place-link')) {
                    return NodeFilter.FILTER_REJECT;
                }
                return NodeFilter.FILTER_ACCEPT;
            }
        }
    );

    const textNodes = [];
    while (walker.nextNode()) {
        textNodes.push(walker.currentNode);
    }

    // Process each text node
    textNodes.forEach(textNode => {
        const text = textNode.textContent;

        // Find all matches with their positions
        const matches = [];
        for (const placeName of placeNames) {
            const regex = new RegExp(`\\b${escapeRegex(placeName)}\\b`, 'gi');
            let match;
            while ((match = regex.exec(text)) !== null) {
                // Check if this position overlaps with an existing match
                const overlaps = matches.some(m =>
                    (match.index >= m.start && match.index < m.end) ||
                    (match.index + match[0].length > m.start && match.index + match[0].length <= m.end)
                );
                if (!overlaps) {
                    matches.push({
                        start: match.index,
                        end: match.index + match[0].length,
                        text: match[0],
                        placeName: placeName
                    });
                }
            }
        }

        if (matches.length === 0) return;

        // Sort matches by position
        matches.sort((a, b) => a.start - b.start);

        // Create a document fragment with the new content
        const fragment = document.createDocumentFragment();
        let lastEnd = 0;

        matches.forEach(({ start, end, text: matchText, placeName }) => {
            // Add text before this match
            if (start > lastEnd) {
                fragment.appendChild(document.createTextNode(text.slice(lastEnd, start)));
            }

            // Add the clickable span
            const span = document.createElement('span');
            span.className = 'place-link';
            span.textContent = matchText;
            span.dataset.place = placeName.toLowerCase();
            span.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.place-link.highlighted').forEach(el => {
                    el.classList.remove('highlighted');
                });
                span.classList.add('highlighted');
                highlightPlace(placeName);
            });
            fragment.appendChild(span);

            lastEnd = end;
        });

        // Add remaining text after the last match
        if (lastEnd < text.length) {
            fragment.appendChild(document.createTextNode(text.slice(lastEnd)));
        }

        textNode.parentNode.replaceChild(fragment, textNode);
    });
}

function escapeRegex(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// Reverse mapping from day numbers to segment indices
const dayToSegmentMapping = {
    'trip01': {
        // Pakistan & India (segments 31-53)
        48: { part: 1, segmentIndex: 31 },  // Karachi → Multan
        50: { part: 1, segmentIndex: 32 },  // Multan → Lahore
        52: { part: 1, segmentIndex: 33 },  // Lahore → Islamabad
        54: { part: 1, segmentIndex: 34 },  // Islamabad → Abbottabad
        55: { part: 1, segmentIndex: 36 },  // Besham → Chilas
        56: { part: 1, segmentIndex: 37 },  // Chilas → Gilgit
        58: { part: 1, segmentIndex: 38 },  // Gilgit → Hunza Valley
        61: { part: 1, segmentIndex: 40 },  // Attabad Lake → Khunjerab Pass
        62: { part: 1, segmentIndex: 41 },  // Khunjerab Pass → Gilgit (return)
        63: { part: 1, segmentIndex: 42 },  // Gilgit → Chilas (return)
        64: { part: 1, segmentIndex: 43 },  // Chilas → Besham (return)
        65: { part: 1, segmentIndex: 44 },  // Besham → Islamabad (return)
        66: { part: 1, segmentIndex: 45 },  // Islamabad → Lahore (return)
        67: { part: 1, segmentIndex: 46 },  // Lahore → Amritsar
        69: { part: 1, segmentIndex: 47 },  // Amritsar → Chandigarh
        70: { part: 1, segmentIndex: 48 },  // Chandigarh → Manali
        72: { part: 1, segmentIndex: 49 },  // Manali → Leh
        76: { part: 1, segmentIndex: 50 },  // Leh → Manali (return)
        78: { part: 1, segmentIndex: 51 },  // Manali → Spiti Valley
        79: { part: 1, segmentIndex: 52 },  // Spiti Valley → Shimla
        81: { part: 1, segmentIndex: 53 }   // Shimla → Delhi
    },
    'trip02': {
        // Trip 2 segments (now indices 0-34)
        2: { part: 2, segmentIndex: 0 },   // Delhi → Agra
        4: { part: 2, segmentIndex: 1 },   // Agra → Jaipur
        6: { part: 2, segmentIndex: 2 },   // Jaipur → Jodhpur
        8: { part: 2, segmentIndex: 3 },   // Jodhpur → Jaisalmer
        10: { part: 2, segmentIndex: 4 },  // Jaisalmer → Udaipur
        12: { part: 2, segmentIndex: 5 },  // Udaipur → Rann of Kutch
        14: { part: 2, segmentIndex: 6 },  // Rann of Kutch → Ahmedabad
        15: { part: 2, segmentIndex: 7 },  // Ahmedabad → Mumbai
        17: { part: 2, segmentIndex: 8 },  // Mumbai → Goa
        20: { part: 2, segmentIndex: 9 },  // Goa → Hampi
        22: { part: 2, segmentIndex: 10 }, // Hampi → Bangalore
        23: { part: 2, segmentIndex: 11 }, // Bangalore → Kochi
        25: { part: 2, segmentIndex: 12 }, // Kochi → Munnar
        27: { part: 2, segmentIndex: 13 }, // Munnar → Alleppey
        28: { part: 2, segmentIndex: 14 }, // Alleppey → Madurai
        30: { part: 2, segmentIndex: 15 }, // Madurai → Pondicherry
        31: { part: 2, segmentIndex: 16 }, // Pondicherry → Chennai
        32: { part: 2, segmentIndex: 17 }, // Chennai → Nellore
        33: { part: 2, segmentIndex: 19 }, // Continue → Visakhapatnam
        34: { part: 2, segmentIndex: 20 }, // Visakhapatnam → Kolkata
        37: { part: 2, segmentIndex: 21 }, // Kolkata → Varanasi
        40: { part: 2, segmentIndex: 22 }, // Varanasi → Kathmandu
        42: { part: 2, segmentIndex: 23 }, // Kathmandu → Bhaktapur
        43: { part: 2, segmentIndex: 24 }, // Bhaktapur → Nagarkot
        44: { part: 2, segmentIndex: 25 }, // Nagarkot → Pokhara
        47: { part: 2, segmentIndex: 26 }, // Pokhara → Lumbini
        48: { part: 2, segmentIndex: 27 }, // Lumbini → Chitwan
        50: { part: 2, segmentIndex: 28 }, // Chitwan → Paharpur
        52: { part: 2, segmentIndex: 29 }, // Paharpur → Dhaka
        54: { part: 2, segmentIndex: 30 }, // Dhaka → Sundarbans
        56: { part: 2, segmentIndex: 31 }, // Sundarbans → Khulna
        57: { part: 2, segmentIndex: 32 }, // Khulna → Dhaka
        58: { part: 2, segmentIndex: 33 }, // Dhaka → Cox's Bazar
        60: { part: 2, segmentIndex: 34 }  // Cox's Bazar → Chittagong
    }
};

// Add click handlers to day headings to highlight route or fly to location
function linkDaysToRoute(contentEl, page) {
    const tripMapping = dayToSegmentMapping[page];

    // Find all h3 headings that match "Day X:" pattern
    contentEl.querySelectorAll('h3').forEach(heading => {
        const text = heading.textContent;
        const dayMatch = text.match(/^Day\s+(\d+)/i);
        if (!dayMatch) return;

        const dayNum = parseInt(dayMatch[1], 10);
        const segment = tripMapping ? tripMapping[dayNum] : null;

        // Extract location from heading (e.g., "Day 3: Agra" → "Agra")
        // Handle formats like "Day 3: Agra" or "Day 4: Agra → Jaipur"
        const locationMatch = text.match(/^Day\s+\d+[^:]*:\s*([^→—]+)/i);
        const locationName = locationMatch ? locationMatch[1].trim() : null;

        // Style the heading as a clickable link
        heading.classList.add('day-heading-link');

        heading.addEventListener('click', (e) => {
            // Don't interfere with link clicks inside the heading
            if (e.target.tagName === 'A') return;

            if (segment) {
                // Driving day - highlight the route segment
                highlightRouteSegment(segment.part, segment.segmentIndex);
            } else if (locationName) {
                // Rest day - fly to the location
                flyToLocation(locationName);
            }
        });
    });
}

// Fly to a location by name using placeIndex
function flyToLocation(locationName) {
    const key = locationName.toLowerCase().trim();
    let place = placeIndex[key];

    // If direct lookup fails, try several fallback strategies:
    if (!place) {
        // 1. Search for POIs containing this city name in parentheses
        // e.g., "Jaipur" matches "Amber Fort (Jaipur)" or "Hawa Mahal (Jaipur)"
        const parenPattern = new RegExp(`\\(${escapeRegex(key)}\\)`, 'i');
        for (const [name, data] of Object.entries(placeIndex)) {
            if (parenPattern.test(name)) {
                place = data;
                break;
            }
        }
    }

    if (!place) {
        // 2. Search for POIs that start with or contain the city name
        // e.g., "Varanasi" matches "Varanasi Ghats"
        for (const [name, data] of Object.entries(placeIndex)) {
            if (name.startsWith(key) || name.includes(key + ' ')) {
                place = data;
                break;
            }
        }
    }

    if (place && place.coords) {
        map.flyTo({
            center: place.coords,
            zoom: 10,
            duration: 1000
        });

        // Briefly highlight the place if it exists on the map
        if (place.name) {
            highlightPlace(place.name);
        }
    } else {
        console.log('Location not found:', locationName);
    }
}

// Highlight a specific route segment on the map
function highlightRouteSegment(part, segmentIndex) {
    if (!map.getSource('planned-route') || !routeData) return;

    // Set the highlight filter
    map.setFilter('planned-route-segment-highlight', [
        'all',
        ['==', ['get', 'part'], part],
        ['==', ['get', 'segmentIndex'], segmentIndex]
    ]);

    // Find the segment's bounding box to fly to it
    const features = routeData.features || [];
    const segment = features.find(f =>
        f.properties.part === part &&
        f.properties.segmentIndex === segmentIndex &&
        f.geometry.type === 'LineString'
    );

    if (segment && segment.geometry.coordinates.length > 0) {
        const coords = segment.geometry.coordinates;
        // Calculate bounding box
        let minLng = Infinity, maxLng = -Infinity;
        let minLat = Infinity, maxLat = -Infinity;
        coords.forEach(([lng, lat]) => {
            minLng = Math.min(minLng, lng);
            maxLng = Math.max(maxLng, lng);
            minLat = Math.min(minLat, lat);
            maxLat = Math.max(maxLat, lat);
        });

        map.fitBounds([[minLng, minLat], [maxLng, maxLat]], {
            padding: 80,
            duration: 1000
        });
    }

    // Clear highlight after 5 seconds
    setTimeout(() => {
        map.setFilter('planned-route-segment-highlight', ['==', ['get', 'segmentIndex'], -1]);
    }, 5000);
}

// Initial load
map.on('load', () => {
    setupTerrain();
    addDataLayers();
});

map.addControl(new mapboxgl.NavigationControl());

// ============ RESIZE HANDLE ============
const resizeHandle = document.getElementById('resize-handle');
const mapPanel = document.querySelector('.map-panel');
const container = document.querySelector('.container');

let isResizing = false;

resizeHandle.addEventListener('mousedown', (e) => {
    isResizing = true;
    resizeHandle.classList.add('dragging');
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
});

document.addEventListener('mousemove', (e) => {
    if (!isResizing) return;

    const containerRect = container.getBoundingClientRect();
    const newWidth = e.clientX - containerRect.left;
    const minWidth = 300;
    const maxWidth = containerRect.width - 300;

    if (newWidth >= minWidth && newWidth <= maxWidth) {
        mapPanel.style.width = newWidth + 'px';
        map.resize();
    }
});

document.addEventListener('mouseup', () => {
    if (isResizing) {
        isResizing = false;
        resizeHandle.classList.remove('dragging');
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
    }
});
</script>
</body>
</html>
